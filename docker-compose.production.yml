# Production docker-compose: Simple single-container deployment with SQLite
# Usage: IMAGE_TAG=v2.4.5B docker-compose -f docker-compose.production.yml up -d
#
# Prerequisites:
# 1. Run GitHub Actions workflow to build and push images
# 2. Login to Aliyun ACR: docker login --username=<aliyun-account> crpi-e8rx4zmw033zfnrz.cn-hangzhou.personal.cr.aliyuncs.com
# 3. Update IMAGE_TAG below to your desired version (e.g., v2.4.5B, latest)

services:
  # TranslateFlow Application (SQLite mode)
  app:
    image: crpi-e8rx4zmw033zfnrz.cn-hangzhou.personal.cr.aliyuncs.com/linchong/translateflow:${IMAGE_TAG:-latest}
    container_name: translateflow-app
    ports:
      - "${PORT:-8000}:8000"
    environment:
      # Application Configuration
      - SECRET_KEY=${SECRET_KEY:-changeme-in-production-please-generate-a-secure-key}
      - PYTHONUNBUFFERED=1
      - RUNNING_IN_DOCKER=true
      - HOST=0.0.0.0
      - PORT=${PORT:-8000}
      # SQLite mode (default, no PostgreSQL needed)
      - USE_SQLITE=true

      # Email Configuration (Optional - choose one provider)
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@translateflow.local}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-TranslateFlow}
      - EMAIL_REPLY_TO=${EMAIL_REPLY_TO:-}

      # Stripe Payment Configuration (Optional)
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - STRIPE_PRICE_FREE=${STRIPE_PRICE_FREE:-}
      - STRIPE_PRICE_STARTER=${STRIPE_PRICE_STARTER:-}
      - STRIPE_PRICE_PRO=${STRIPE_PRICE_PRO:-}
      - STRIPE_PRICE_ENTERPRISE=${STRIPE_PRICE_ENTERPRISE:-}

      # OAuth Providers (Optional)
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - OAUTH_REDIRECT_URI=${OAUTH_REDIRECT_URI:-http://localhost:8000/auth/callback}

    volumes:
      # Mount output directories for persistence
      - ./output:/app/output
      - ./updatetemp:/app/updatetemp
      # SQLite database persistence
      - ./data:/app/data

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/system/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
