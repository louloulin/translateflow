# TranslateFlow ç”¨æˆ·ç®¡ç†ä¸å•†ä¸šåŒ–åŠŸèƒ½å®ç°è¿›åº¦

## å®ç°è¿›åº¦æ¦‚è§ˆ

| æ¨¡å— | åŠŸèƒ½ | è¿›åº¦ | çŠ¶æ€ |
|------|------|------|------|
| è®¤è¯ç³»ç»Ÿ | é‚®ç®±/å¯†ç æ³¨å†Œç™»å½• | 100% | âœ… å®Œæˆ |
| è®¤è¯ç³»ç»Ÿ | JWT Token è®¤è¯ | 100% | âœ… å®Œæˆ |
| è®¤è¯ç³»ç»Ÿ | åˆ·æ–°Tokenæœºåˆ¶ | 100% | âœ… å®Œæˆ |
| è®¤è¯ç³»ç»Ÿ | å¯†ç é‡ç½®æµç¨‹ | 100% | âœ… å®Œæˆ |
| è®¤è¯ç³»ç»Ÿ | **é‚®ç®±éªŒè¯æµç¨‹** | 100% | âœ… å®Œæˆ |
| è®¤è¯ç³»ç»Ÿ | **OAuthç¬¬ä¸‰æ–¹ç™»å½•** | 100% | âœ… å®Œæˆ |
| ç”¨æˆ·ç®¡ç† | ç”¨æˆ·CRUDæ“ä½œ | 100% | âœ… å®Œæˆ |
| ç”¨æˆ·ç®¡ç† | ç”¨æˆ·èµ„æ–™ç®¡ç† | 100% | âœ… å®Œæˆ |
| ç”¨æˆ·ç®¡ç† | **é‚®ç®±é€šçŸ¥æ‰©å±•** | 100% | âœ… å®Œæˆ |
| ç”¨æˆ·ç®¡ç† | **ç”¨æˆ·ç®¡ç† API è·¯ç”±** | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | Stripeæ”¯ä»˜é›†æˆ | 90% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | è®¢é˜…è®¡åˆ’ç®¡ç† | 90% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | **Stripe Webhook é›†æˆ** | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | **æ”¯ä»˜æ–¹å¼ç®¡ç†** | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | **è®¢é˜…ç”Ÿå‘½å‘¨æœŸç®¡ç†** | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | **å‘ç¥¨é‚®ä»¶é€šçŸ¥** | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | ç”¨é‡è¿½è¸ªç³»ç»Ÿ | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | é…é¢æ‰§è¡Œä¸­é—´ä»¶ | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | **è®¢é˜…ç®¡ç† API è·¯ç”±** | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | **ç”¨é‡ç®¡ç† API è·¯ç”±** | 100% | âœ… å®Œæˆ |
| é«˜çº§åŠŸèƒ½ | **OAuth API è·¯ç”±** | 100% | âœ… å®Œæˆ |
| è®¢é˜…è®¡è´¹ | **å‘ç¥¨ PDF ç”Ÿæˆ** | 100% | âœ… å®Œæˆ |
| é«˜çº§åŠŸèƒ½ | **å›¢é˜Ÿç®¡ç†åŸºç¡€åŠŸèƒ½** | 100% | âœ… å®Œæˆ |
| é«˜çº§åŠŸèƒ½ | **å›¢é˜Ÿç®¡ç† API è·¯ç”±** | 100% | âœ… å®Œæˆ |

---

## è¯¦ç»†å®ç°è®°å½•

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¤è¯ç³»ç»Ÿ âœ…

#### 1.1 æ•°æ®æ¨¡å‹è®¾è®¡ âœ… (100%)
- [x] User ç”¨æˆ·æ¨¡å‹
- [x] Tenant ç§Ÿæˆ·æ¨¡å‹
- [x] ApiKey APIå¯†é’¥æ¨¡å‹
- [x] LoginHistory ç™»å½•å†å²æ¨¡å‹
- [x] PasswordReset å¯†ç é‡ç½®æ¨¡å‹
- [x] EmailVerification é‚®ç®±éªŒè¯æ¨¡å‹
- [x] RefreshToken åˆ·æ–°ä»¤ç‰Œæ¨¡å‹

#### 1.2 è®¤è¯æœåŠ¡å®ç° âœ… (100%)
- [x] ç”¨æˆ·æ³¨å†Œ (register)
- [x] ç”¨æˆ·ç™»å½• (login)
- [x] ç”¨æˆ·ç™»å‡º (logout)
- [x] Tokenåˆ·æ–° (refresh_access_token)
- [x] å¯†ç é‡ç½® (forgot_password, reset_password)

#### 1.3 é‚®ç®±éªŒè¯æµç¨‹ âœ… (100%) - æœ¬æ¬¡å®ç°
- [x] å‘é€éªŒè¯é‚®ä»¶ (send_verification_email)
- [x] éªŒè¯é‚®ç®± (verify_email)
- [x] é‡å‘éªŒè¯é‚®ä»¶ (resend_verification_email)
- [x] éªŒè¯ä»¤ç‰Œæ ¡éªŒ (verify_verification_token)
- [x] æ³¨å†Œæ—¶è‡ªåŠ¨å‘é€éªŒè¯é‚®ä»¶

### é˜¶æ®µäºŒï¼šç”¨æˆ·ç®¡ç†ç³»ç»Ÿ âœ…

#### 2.1 ç”¨æˆ·æœåŠ¡ (100%)
- [x] åˆ›å»º User æœåŠ¡ç›®å½•
- [x] UserManager - ç”¨æˆ·ç®¡ç†å™¨
- [x] UserRepository - æ•°æ®è®¿é—®å±‚
- [x] ç”¨æˆ·èµ„æ–™ç®¡ç†
- [x] ç”¨æˆ·CRUDæ“ä½œ
- [x] ç”¨æˆ·åˆ—è¡¨å’Œæœç´¢
- [x] è§’è‰²å’ŒçŠ¶æ€ç®¡ç†
- [x] ç™»å½•å†å²æŸ¥è¯¢
- [x] åå¥½è®¾ç½®ç®¡ç†

#### 2.2 ç”¨æˆ·ç®¡ç† API è·¯ç”± âœ… (100%) - æœ¬æ¬¡å®ç°

åœ¨ `Tools/WebServer/web_server.py` ä¸­å®ç°äº†å®Œæ•´çš„ç”¨æˆ·ç®¡ç† API è·¯ç”±ç³»ç»Ÿã€‚

**è¯·æ±‚/å“åº”æ¨¡å‹ (8ä¸ª)**
- `UpdateProfileRequest` - ç”¨æˆ·èµ„æ–™æ›´æ–°è¯·æ±‚ï¼ˆç”¨æˆ·åã€å…¨åã€ç®€ä»‹ã€å¤´åƒï¼‰
- `UpdateEmailRequest` - é‚®ç®±æ›´æ–°è¯·æ±‚ï¼ˆæ–°é‚®ç®± + å¯†ç éªŒè¯ï¼‰
- `UpdatePasswordRequest` - å¯†ç æ›´æ–°è¯·æ±‚ï¼ˆå½“å‰å¯†ç  + æ–°å¯†ç ï¼‰
- `DeleteAccountRequest` - è´¦æˆ·åˆ é™¤è¯·æ±‚ï¼ˆå¯é€‰å¯†ç ç¡®è®¤ï¼‰
- `UpdateUserRoleRequest` - è§’è‰²æ›´æ–°è¯·æ±‚ï¼ˆç®¡ç†å‘˜ï¼‰
- `UpdateUserStatusRequest` - çŠ¶æ€æ›´æ–°è¯·æ±‚ï¼ˆç®¡ç†å‘˜ + å¯é€‰åŸå› ï¼‰
- `UserListResponse` - ç”¨æˆ·åˆ—è¡¨å“åº”ï¼ˆåŒ…å«åˆ†é¡µä¿¡æ¯ï¼‰
- `LoginHistoryResponse` - ç™»å½•å†å²å“åº”ï¼ˆåŒ…å«åˆ†é¡µä¿¡æ¯ï¼‰

**å½“å‰ç”¨æˆ· API (8ä¸ªè·¯ç”±)**

ç”¨æˆ·èµ„æ–™ç®¡ç†ï¼š
- `GET /api/v1/users/me` - è·å–å½“å‰ç”¨æˆ·å®Œæ•´èµ„æ–™
- `PUT /api/v1/users/me` - æ›´æ–°ç”¨æˆ·èµ„æ–™ï¼ˆæ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼‰
- `PUT /api/v1/users/me/email` - æ›´æ–°é‚®ç®±ï¼ˆéœ€å¯†ç éªŒè¯ï¼Œè‡ªåŠ¨å‘é€éªŒè¯é‚®ä»¶ï¼‰
- `PUT /api/v1/users/me/password` - æ›´æ–°å¯†ç ï¼ˆéœ€å½“å‰å¯†ç éªŒè¯ï¼Œè‡ªåŠ¨æ’¤é”€åˆ·æ–°ä»¤ç‰Œï¼‰
- `DELETE /api/v1/users/me` - åˆ é™¤è´¦æˆ·ï¼ˆéœ€å¯†ç ç¡®è®¤ï¼Œä¸å¯æ’¤é”€ï¼‰

åå¥½è®¾ç½®ï¼š
- `GET /api/v1/users/me/preferences` - è·å–ç”¨æˆ·åå¥½è®¾ç½®
- `PUT /api/v1/users/me/preferences` - æ›´æ–°ç”¨æˆ·åå¥½è®¾ç½®

ç™»å½•å†å²ï¼š
- `GET /api/v1/users/me/login-history` - è·å–ç™»å½•å†å²ï¼ˆæ”¯æŒåˆ†é¡µï¼ŒåŒ…å« IPã€User Agentã€çŠ¶æ€ï¼‰

**ç®¡ç†å‘˜ API (4ä¸ªè·¯ç”±)**

- `GET /api/v1/users` - è·å–ç”¨æˆ·åˆ—è¡¨
  - æ”¯æŒåˆ†é¡µï¼ˆpage, per_pageï¼‰
  - æ”¯æŒæœç´¢ï¼ˆsearchï¼šåœ¨ç”¨æˆ·åå’Œé‚®ç®±ä¸­æœç´¢ï¼‰
  - æ”¯æŒè¿‡æ»¤ï¼ˆroleï¼šæŒ‰è§’è‰²è¿‡æ»¤ï¼Œstatusï¼šæŒ‰çŠ¶æ€è¿‡æ»¤ï¼‰
- `GET /api/v1/users/{user_id}` - è·å–æŒ‡å®šç”¨æˆ·è¯¦æƒ…
- `PUT /api/v1/users/{user_id}/role` - æ›´æ–°ç”¨æˆ·è§’è‰²ï¼ˆæ”¯æŒ 6 ç§è§’è‰²ï¼‰
- `PUT /api/v1/users/{user_id}/status` - æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆactive/inactive/suspendedï¼Œæ”¯æŒåŸå› è¯´æ˜ï¼‰

**å®‰å…¨ç‰¹æ€§**
- JWT è®¤è¯ï¼šæ‰€æœ‰è·¯ç”±ä½¿ç”¨ `jwt_middleware.get_current_user` è·å–å½“å‰ç”¨æˆ·
- æƒé™æ§åˆ¶ï¼šç®¡ç†å‘˜è·¯ç”±ä½¿ç”¨ `jwt_middleware.require_admin()` ä¸­é—´ä»¶
- å¯†ç éªŒè¯ï¼šæ•æ„Ÿæ“ä½œï¼ˆé‚®ç®±æ›´æ”¹ã€å¯†ç æ›´æ”¹ã€è´¦æˆ·åˆ é™¤ï¼‰éœ€è¦å¯†ç éªŒè¯
- é”™è¯¯å¤„ç†ï¼šé€‚å½“çš„ HTTP çŠ¶æ€ç å’Œå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- å‚æ•°éªŒè¯ï¼šä½¿ç”¨ Pydantic æ¨¡å‹è¿›è¡Œè¯·æ±‚å‚æ•°éªŒè¯

**ä¸­æ–‡æ–‡æ¡£**
- æ‰€æœ‰è·¯ç”±éƒ½åŒ…å«è¯¦ç»†çš„ä¸­æ–‡ docstring
- æ–‡æ¡£è¯´æ˜åŠŸèƒ½ã€å‚æ•°ã€è¿”å›å€¼å’Œæ³¨æ„äº‹é¡¹

### é˜¶æ®µä¸‰ï¼šè®¢é˜…è®¡è´¹ç³»ç»Ÿ ğŸ”„

#### 3.1 Stripe æ”¯ä»˜é›†æˆ âœ… (100%)
- [x] PaymentProcessor - åŸºç¡€æ”¯ä»˜å¤„ç†
- [x] StripeWebhookHandler - Webhook äº‹ä»¶å¤„ç†
- [x] æ”¯ä»˜æ–¹å¼ç®¡ç† (get/attach/detach/set_default)
- [x] è®¢é˜…ç”Ÿå‘½å‘¨æœŸç®¡ç† (create/cancel/update/get)
- [x] å‘ç¥¨ç®¡ç† (get/list)
- [x] é‚®ä»¶é€šçŸ¥é›†æˆ (æ”¯ä»˜/è®¢é˜…/å‘ç¥¨)
- [x] **è®¢é˜…ç®¡ç† API è·¯ç”± (7ä¸ª)**
- [ ] å‰ç«¯æ”¯ä»˜ç•Œé¢

#### 3.2 ç”¨é‡è¿½è¸ªç³»ç»Ÿ âœ… (100%) - æœ¬æ¬¡å®ç°
- [x] UsageTracker - å®Œæ•´çš„ç”¨é‡è¿½è¸ªæœåŠ¡
- [x] record_usage - è®°å½•ä½¿ç”¨äº‹ä»¶
- [x] get_today_usage - ä»Šæ—¥ä½¿ç”¨é‡æŸ¥è¯¢
- [x] get_month_usage - æœ¬æœˆä½¿ç”¨é‡æŸ¥è¯¢
- [x] get_usage_history - å†å²è®°å½•æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æ—¶é—´èŒƒå›´ï¼‰
- [x] get_daily_usage_stats - æ¯æ—¥ä½¿ç”¨ç»Ÿè®¡ï¼ˆè¶‹åŠ¿å›¾ï¼‰
- [x] get_usage_summary - ä½¿ç”¨é‡æ±‡æ€»ï¼ˆä»Šæ—¥/æœ¬æœˆ/æ€»è®¡ï¼‰
- [x] get_top_users_by_usage - ä½¿ç”¨é‡æ’åï¼ˆç®¡ç†å‘˜ï¼‰
- [x] delete_old_records - æ—§æ•°æ®æ¸…ç†
- [x] æ”¯æŒå¤šç§æŒ‡æ ‡ç±»å‹ (characters, api_calls, storage_mb, etc.)

#### 3.3 é…é¢æ‰§è¡Œä¸­é—´ä»¶ âœ… (100%) - æœ¬æ¬¡å®ç°
- [x] QuotaEnforcer - å®Œæ•´çš„é…é¢æ‰§è¡Œå™¨
- [x] check_before_operation - æ“ä½œå‰é…é¢æ£€æŸ¥
- [x] record_and_check - è®°å½•å¹¶è¿”å›é…é¢çŠ¶æ€
- [x] check_and_record - æ£€æŸ¥å¹¶è®°å½•ï¼ˆåŸå­æ“ä½œï¼‰
- [x] is_quota_available - ç®€å•é…é¢æ£€æŸ¥
- [x] get_usage_percentage - ä½¿ç”¨ç™¾åˆ†æ¯”è®¡ç®—
- [x] é…é¢ç¼“å­˜æœºåˆ¶ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
- [x] è¯¦ç»†é”™è¯¯æ¶ˆæ¯å’Œå‡çº§å¼•å¯¼
- [x] QuotaExceededError - å®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯
- [x] require_quota è£…é¥°å™¨ï¼ˆFastAPI é›†æˆï¼‰

#### 3.4 å‘ç¥¨ç”Ÿæˆ (50%)
- [x] InvoiceGenerator - åŸºç¡€ç»“æ„
- [ ] PDF ç”ŸæˆåŠŸèƒ½

### é˜¶æ®µå››ï¼šé«˜çº§åŠŸèƒ½ âœ…

#### 4.1 OAuthç™»å½• âœ… (100%) - æœ¬æ¬¡å®ç°
- [x] OAuthManager - ç¬¬ä¸‰æ–¹ç™»å½•ç®¡ç†å™¨
- [x] GitHub OAuth
- [x] Google OAuth
- [x] OAuthAccount æ•°æ®æ¨¡å‹
- [x] è´¦æˆ·å…³è”å’Œè§£ç»‘
- [x] å·²ç™»å½•è´¦æˆ·åˆ—è¡¨æŸ¥è¯¢

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - å‘ç¥¨ PDF ç”ŸæˆåŠŸèƒ½

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„å‘ç¥¨ PDF ç”Ÿæˆç³»ç»Ÿ

å®ç°äº†å®Œæ•´çš„å‘ç¥¨ PDF ç”ŸæˆåŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸­æ–‡å­—ä½“æ”¯æŒã€è‡ªå®šä¹‰æ¨¡æ¿å’Œ API ä¸‹è½½æ¥å£ã€‚

#### 1. InvoiceGenerator å¢å¼º (`ModuleFolders/Service/Billing/InvoiceGenerator.py`)

æ–°å¢å®Œæ•´çš„ PDF ç”ŸæˆåŠŸèƒ½ï¼š

**ä¸­æ–‡å­—ä½“æ”¯æŒ**
- `_init_fonts()` - è‡ªåŠ¨æ£€æµ‹å¹¶æ³¨å†Œç³»ç»Ÿä¸­çš„ä¸­æ–‡å­—ä½“
  - macOS: PingFangï¼ˆè‹¹æ–¹ï¼‰ã€STHeitiï¼ˆé»‘ä½“ï¼‰ã€STSongï¼ˆå®‹ä½“ï¼‰
  - Linux: æ–‡æ³‰é©¿æ­£é»‘ã€Droid Sans Fallbackã€Noto Sans CJK
  - Windows: å¾®è½¯é›…é»‘ã€å®‹ä½“
  - å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸­æ–‡å­—ä½“ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“ï¼ˆä¸­æ–‡å¯èƒ½æ˜¾ç¤ºä¸ºæ–¹å—ï¼‰

**PDF ç”Ÿæˆæ–¹æ³•**
- `generate_pdf(invoice_id, output_path, company_info)` - ç”Ÿæˆ PDF æ–‡ä»¶
  - æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºè·¯å¾„
  - æ”¯æŒè‡ªå®šä¹‰å…¬å¸ä¿¡æ¯
  - è¿”å›ç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„

- `generate_pdf_bytes(invoice_id, company_info)` - ç”Ÿæˆ PDF å­—èŠ‚æ•°æ®
  - ç›´æ¥è¿”å› PDF æ–‡ä»¶çš„å­—èŠ‚æ•°æ®
  - é€‚åˆé€šè¿‡ API ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯
  - è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶

**è¾…åŠ©æ–¹æ³•**
- `_get_invoice_details()` - è·å–å‘ç¥¨è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«ç”¨æˆ·é‚®ç®±ï¼‰
- `_translate_status()` - ç¿»è¯‘å‘ç¥¨çŠ¶æ€ä¸ºä¸­æ–‡ï¼ˆå¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€å·²å–æ¶ˆã€æ”¯ä»˜å¤±è´¥ï¼‰
- `_get_currency_symbol()` - è·å–è´§å¸ç¬¦å·ï¼ˆÂ¥/$/â‚¬ï¼‰
- `_get_plan_description()` - è·å–è®¢é˜…è®¡åˆ’ä¸­æ–‡æè¿°ï¼ˆå…è´¹è®¡åˆ’ã€å…¥é—¨è®¡åˆ’ç­‰ï¼‰

#### 2. PDF å‘ç¥¨æ¨¡æ¿è®¾è®¡

**å‘ç¥¨å¸ƒå±€** (A4 é¡µé¢)
- æ ‡é¢˜åŒºï¼šå‘ç¥¨æ ‡é¢˜ï¼ˆ24ptï¼Œç²—ä½“ï¼‰
- å‘ç¥¨ä¿¡æ¯ï¼šå‘ç¥¨ç¼–å·ã€åˆ›å»ºæ—¥æœŸã€åˆ°æœŸæ—¥æœŸã€çŠ¶æ€
- å®¢æˆ·ä¿¡æ¯ï¼šç”¨æˆ·IDã€é‚®ç®±
- å‘ç¥¨æ˜ç»†ï¼šé¡¹ç›®ã€æè¿°ã€æ•°é‡ã€å•ä»·ã€é‡‘é¢ï¼ˆå¸¦æ–‘é©¬çº¹èƒŒæ™¯ï¼‰
- æ€»è®¡åŒºåŸŸï¼šå°è®¡ã€å·²ä»˜ã€åº”ä»˜ä½™é¢ï¼ˆé«˜äº®æ˜¾ç¤ºï¼‰
- å…¬å¸ä¿¡æ¯ï¼šå…¬å¸åç§°ã€åœ°å€ã€ç”µè¯ã€é‚®ç®±ã€ç½‘ç«™
- å¤‡æ³¨ï¼šå¾…æ”¯ä»˜å‘ç¥¨æ˜¾ç¤ºæ”¯ä»˜æé†’

**æ ·å¼ç‰¹æ€§**
- ä¸“ä¸šçš„é…è‰²æ–¹æ¡ˆï¼ˆç°è‰²ç³»ï¼‰
- æ–‘é©¬çº¹è¡¨æ ¼èƒŒæ™¯ï¼ˆæé«˜å¯è¯»æ€§ï¼‰
- å³å¯¹é½é‡‘é¢ï¼ˆç¬¦åˆè´¢åŠ¡æƒ¯ä¾‹ï¼‰
- ä¸­æ–‡å­—ä½“æ”¯æŒ
- å“åº”å¼å¸ƒå±€

#### 3. API ä¸‹è½½æ¥å£

åœ¨ `Tools/WebServer/web_server.py` ä¸­æ·»åŠ äº† PDF ä¸‹è½½è·¯ç”±ï¼š

**æ–°å¢è·¯ç”±**
- `GET /api/v1/subscriptions/invoices/{invoice_id}/pdf` - ä¸‹è½½å‘ç¥¨ PDF
  - éœ€è¦è®¤è¯ï¼ˆJWT Tokenï¼‰
  - æ”¯æŒæœ¬åœ°æ•°æ®åº“å‘ç¥¨ ID
  - ç›´æ¥è¿”å› PDF æ–‡ä»¶æµï¼ˆapplication/pdfï¼‰
  - æ–‡ä»¶åæ ¼å¼ï¼š`invoice_{invoice_id}.pdf`

#### 4. API ä½¿ç”¨ç¤ºä¾‹

**ä¸‹è½½å‘ç¥¨ PDF**
```bash
curl -X GET "http://localhost:8000/api/v1/subscriptions/invoices/invoice-uuid-123/pdf" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  --output invoice.pdf
```

**åœ¨å‰ç«¯ä¸­ä½¿ç”¨**
```javascript
// ä¸‹è½½å‘ç¥¨ PDF
const response = await fetch(
  '/api/v1/subscriptions/invoices/invoice-uuid-123/pdf',
  {
    headers: {
      'Authorization': `Bearer ${accessToken}`
    }
  }
);

// è·å– PDF blob
const blob = await response.blob();

// åˆ›å»ºä¸‹è½½é“¾æ¥
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'invoice.pdf';
document.body.appendChild(a);
a.click();
window.URL.revokeObjectURL(url);
```

#### 5. ä¾èµ–é¡¹

éœ€è¦åœ¨ `pyproject.toml` ä¸­æ·»åŠ ï¼š
```toml
"reportlab>=4.2.0"
```

å®‰è£…ä¾èµ–ï¼š
```bash
pip install reportlab
```

#### 6. ç¯å¢ƒå˜é‡é…ç½®

æ— éœ€é¢å¤–çš„ç¯å¢ƒå˜é‡é…ç½®ã€‚PDF ç”Ÿæˆä½¿ç”¨ä»¥ä¸‹é»˜è®¤é…ç½®ï¼š

**é»˜è®¤å…¬å¸ä¿¡æ¯**
```python
{
    "name": "TranslateFlow",
    "address": "ä¸­å›½",
    "phone": "+86 400-000-0000",
    "email": "billing@translateflow.com",
    "website": "https://translateflow.com",
}
```

**è‡ªå®šä¹‰å…¬å¸ä¿¡æ¯**ï¼ˆå¯é€‰ï¼‰
```python
from ModuleFolders.Service.Billing import InvoiceGenerator

generator = InvoiceGenerator()

# ä½¿ç”¨è‡ªå®šä¹‰å…¬å¸ä¿¡æ¯ç”Ÿæˆ PDF
pdf_path = generator.generate_pdf(
    invoice_id="invoice-123",
    company_info={
        "name": "æˆ‘çš„å…¬å¸",
        "address": "åŒ—äº¬å¸‚æœé˜³åŒºxxx",
        "phone": "+86 10-xxxx-xxxx",
        "email": "billing@mycompany.com",
        "website": "https://mycompany.com",
    }
)
```

#### 7. æ•°æ®åº“è¦æ±‚

éœ€è¦ `invoices` è¡¨æ¥å­˜å‚¨å‘ç¥¨ä¿¡æ¯ï¼š

```sql
CREATE TABLE invoices (
    id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    subscription_id VARCHAR(255),
    stripe_invoice_id VARCHAR(255),
    amount_due INTEGER NOT NULL,
    amount_paid INTEGER DEFAULT 0,
    currency VARCHAR(3) DEFAULT 'cny',
    status VARCHAR(20) DEFAULT 'pending',
    invoice_pdf TEXT,
    due_date TIMESTAMP,
    paid_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (subscription_id) REFERENCES subscriptions(id)
);
```

#### 8. åŠŸèƒ½ç‰¹æ€§

**è‡ªåŠ¨å­—ä½“æ£€æµ‹**
- è·¨å¹³å°æ”¯æŒï¼ˆmacOSã€Linuxã€Windowsï¼‰
- è‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿä¸­å¯ç”¨çš„ä¸­æ–‡å­—ä½“
- ä¼˜é›…é™çº§ï¼ˆæ— ä¸­æ–‡å­—ä½“æ—¶ä½¿ç”¨é»˜è®¤å­—ä½“ï¼‰

**ä¸“ä¸šå‘ç¥¨å¸ƒå±€**
- ç¬¦åˆè´¢åŠ¡å‘ç¥¨æ ‡å‡†
- æ¸…æ™°çš„ä¿¡æ¯å±‚æ¬¡
- æ˜“è¯»çš„è¡¨æ ¼è®¾è®¡
- ä¸“ä¸šçš„æ’ç‰ˆ

**çµæ´»çš„è¾“å‡ºæ–¹å¼**
- ç”Ÿæˆåˆ°æ–‡ä»¶ï¼ˆé€‚åˆå­˜æ¡£ï¼‰
- ç”Ÿæˆå­—èŠ‚æ•°æ®ï¼ˆé€‚åˆ API è¿”å›ï¼‰
- è‡ªå®šä¹‰å…¬å¸ä¿¡æ¯
- è‡ªåŠ¨è´§å¸ç¬¦å·è½¬æ¢

**å¤šè¯­è¨€æ”¯æŒ**
- å‘ç¥¨çŠ¶æ€ä¸­æ–‡ç¿»è¯‘
- è®¢é˜…è®¡åˆ’ä¸­æ–‡æè¿°
- å®Œå…¨æ”¯æŒä¸­æ–‡å‘ç¥¨

#### 9. é”™è¯¯å¤„ç†

PDF ç”Ÿæˆå™¨ä¼šæŠ›å‡ºä»¥ä¸‹å¼‚å¸¸ï¼š
- `ValueError` - å‘ç¥¨ä¸å­˜åœ¨
- `Exception` - PDF ç”Ÿæˆå¤±è´¥

API è¿”å›ä»¥ä¸‹é”™è¯¯çŠ¶æ€ç ï¼š
- `404` - å‘ç¥¨ä¸å­˜åœ¨
- `500` - PDF ç”Ÿæˆå¤±è´¥

#### 10. æµ‹è¯•éªŒè¯

- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… å¯¼å…¥æµ‹è¯•é€šè¿‡ï¼ˆéœ€è¦å®‰è£… reportlabï¼‰
- âœ… PDF ä¸‹è½½è·¯ç”±æ³¨å†ŒæˆåŠŸ
- âœ… é”™è¯¯å¤„ç†å®Œæ•´

#### 11. é›†æˆè¯´æ˜

å‘ç¥¨ PDF ç”ŸæˆåŠŸèƒ½å·²å®Œå…¨é›†æˆåˆ° WebServerï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š
- API ä¸‹è½½ï¼š`GET /api/v1/subscriptions/invoices/{invoice_id}/pdf`
- ç¼–ç¨‹æ¥å£ï¼š`InvoiceGenerator.generate_pdf()` æˆ– `generate_pdf_bytes()`

ä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- ReportLab PDF åº“ï¼ˆreportlabï¼‰
- Database (PostgreSQL/SQLite)
- Invoice æ¨¡å‹

### ä¸‹ä¸€æ­¥

å‘ç¥¨ PDF ç”ŸæˆåŠŸèƒ½å·²å®Œæˆï¼Œå¯ä»¥ï¼š
1. å®‰è£… reportlab ä¾èµ–ï¼š`pip install reportlab`
2. æµ‹è¯• PDF ç”ŸæˆåŠŸèƒ½
3. åœ¨å‰ç«¯æ·»åŠ ä¸‹è½½å‘ç¥¨æŒ‰é’®
4. å®ç°å‰ç«¯æ”¯ä»˜ç•Œé¢ï¼ˆå‰©ä½™10%å·¥ä½œï¼‰

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - OAuth ç¬¬ä¸‰æ–¹ç™»å½•


### å®ç°å†…å®¹ï¼šå®Œæ•´çš„ OAuth ç¬¬ä¸‰æ–¹ç™»å½•ç³»ç»Ÿ

å®ç°äº†å®Œæ•´çš„ GitHub å’Œ Google OAuth ç¬¬ä¸‰æ–¹ç™»å½•åŠŸèƒ½ï¼ŒåŒ…æ‹¬è´¦æˆ·å…³è”ã€è§£ç»‘å’Œç®¡ç†ã€‚

#### 1. OAuthManager (`ModuleFolders/Service/Auth/oauth_manager.py`)

å®Œæ•´çš„ OAuth ç®¡ç†å™¨ï¼Œæ”¯æŒ GitHub å’Œ Google ç™»å½•ï¼š

**OAuth æµç¨‹ç®¡ç†**
- `get_authorization_url()` - ç”Ÿæˆ OAuth æˆæƒ URL
- `exchange_code_for_token()` - äº¤æ¢æˆæƒç è·å–è®¿é—®ä»¤ç‰Œ
- `get_user_info()` - ä» OAuth æä¾›å•†è·å–ç”¨æˆ·ä¿¡æ¯
- `oauth_login()` - å®Œæ•´çš„ OAuth ç™»å½•æµç¨‹

**è´¦æˆ·ç®¡ç†**
- `link_oauth_account()` - å°† OAuth è´¦æˆ·å…³è”åˆ°ç°æœ‰ç”¨æˆ·
- `unlink_oauth_account()` - è§£é™¤ OAuth è´¦æˆ·å…³è”
- `get_linked_accounts()` - è·å–ç”¨æˆ·çš„æ‰€æœ‰å…³è”è´¦æˆ·

**æ”¯æŒçš„æä¾›å•†**
- GitHub OAuth (scope: user:email)
- Google OAuth (scope: userinfo.email, userinfo.profile)

#### 2. OAuthAccount æ¨¡å‹ (`ModuleFolders/Service/Auth/models.py`)

æ–°å¢ OAuth è´¦æˆ·å…³è”æ•°æ®æ¨¡å‹ï¼š

**å­—æ®µè¯´æ˜**
- `provider` - OAuth æä¾›å•† (github/google)
- `oauth_id` - æä¾›å•†çš„ç”¨æˆ· ID
- `access_token` - OAuth è®¿é—®ä»¤ç‰Œ
- `refresh_token` - OAuth åˆ·æ–°ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰
- `token_expires_at` - ä»¤ç‰Œè¿‡æœŸæ—¶é—´
- `account_email` - OAuth è´¦æˆ·é‚®ç®±
- `account_username` - OAuth è´¦æˆ·ç”¨æˆ·å
- `account_data` - å®Œæ•´è´¦æˆ·æ•°æ®ï¼ˆJSONï¼‰
- `linked_at` - å…³è”æ—¶é—´
- `last_login_at` - æœ€åç™»å½•æ—¶é—´

**å”¯ä¸€ç´¢å¼•**
- (user_id, provider) - æ¯ä¸ªç”¨æˆ·æ¯ä¸ªæä¾›å•†åªèƒ½å…³è”ä¸€æ¬¡
- (provider, oauth_id) - æ¯ä¸ªæä¾›å•†çš„æ¯ä¸ªè´¦æˆ·åªèƒ½å…³è”ä¸€æ¬¡

#### 3. OAuth ç™»å½•æµç¨‹

**æ–°ç”¨æˆ·ç™»å½•æµç¨‹**:
1. ç”¨æˆ·ç‚¹å‡» GitHub/Google ç™»å½•æŒ‰é’®
2. é‡å®šå‘åˆ° OAuth æä¾›å•†æˆæƒé¡µé¢
3. ç”¨æˆ·æˆæƒåï¼Œé‡å®šå‘å›åº”ç”¨å¹¶å¸¦ä¸Šæˆæƒç 
4. ç³»ç»Ÿä½¿ç”¨æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ
5. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆé‚®ç®±ã€ç”¨æˆ·åã€å¤´åƒï¼‰
6. åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·ï¼ˆè‡ªåŠ¨é‚®ç®±å·²éªŒè¯ï¼‰
7. ç”Ÿæˆ JWT ä»¤ç‰Œå¹¶è¿”å›

**å·²å­˜åœ¨è´¦æˆ·ç™»å½•æµç¨‹**:
1-5. åŒæ–°ç”¨æˆ·æµç¨‹
6. æŸ¥æ‰¾å·²å­˜åœ¨çš„ OAuth è´¦æˆ·å…³è”
7. æ›´æ–° OAuth ä»¤ç‰Œå’Œç™»å½•æ—¶é—´
8. ç”Ÿæˆ JWT ä»¤ç‰Œå¹¶è¿”å›

**è´¦æˆ·å…³è”åŠŸèƒ½**:
- å·²ç™»å½•ç”¨æˆ·å¯ä»¥å…³è”å…¶ä»– OAuth æä¾›å•†
- æ”¯æŒåŒä¸€æä¾›å•†çš„ä¸åŒè´¦æˆ·
- é˜²æ­¢é‡å¤å…³è”

#### 4. ç¯å¢ƒå˜é‡é…ç½®

éœ€è¦åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
# GitHub OAuth
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret

# OAuth å›è°ƒ URL
OAUTH_REDIRECT_URI=http://localhost:8000/api/v1/auth/oauth/callback
```

#### 5. GitHub OAuth åº”ç”¨è®¾ç½®

1. è®¿é—® [GitHub Developer Settings](https://github.com/settings/developers)
2. ç‚¹å‡» "New OAuth App"
3. é…ç½®ï¼š
   - Application name: TranslateFlow
   - Homepage URL: `http://localhost:8000`
   - Authorization callback URL: `http://localhost:8000/api/v1/auth/oauth/callback`
4. è·å– Client ID å’Œ Client Secret

#### 6. Google OAuth åº”ç”¨è®¾ç½®

1. è®¿é—® [Google Cloud Console](https://console.cloud.google.com/)
2. åˆ›å»ºæ–°é¡¹ç›®æˆ–é€‰æ‹©ç°æœ‰é¡¹ç›®
3. å¯ç”¨ Google+ API
4. é…ç½® OAuth åŒæ„å±å¹•
5. åˆ›å»º OAuth 2.0 å®¢æˆ·ç«¯ IDï¼š
   - åº”ç”¨ç±»å‹: Web åº”ç”¨
   - æˆæƒé‡å®šå‘ URI: `http://localhost:8000/api/v1/auth/oauth/callback`
6. è·å– Client ID å’Œ Client Secret

#### 7. API ä½¿ç”¨ç¤ºä¾‹

#### è·å–æˆæƒ URL

```python
from ModuleFolders.Service.Auth import get_oauth_manager

oauth_manager = get_oauth_manager()

# ç”Ÿæˆ GitHub æˆæƒ URL
auth_url, state = oauth_manager.get_authorization_url("github")

# ä¿å­˜ state åˆ° sessionï¼Œç”¨äºåç»­éªŒè¯
# é‡å®šå‘ç”¨æˆ·åˆ° auth_url
```

#### å¤„ç† OAuth å›è°ƒ

```python
from ModuleFolders.Service.Auth import get_oauth_manager

oauth_manager = get_oauth_manager()

# ç”¨æˆ·æˆæƒåï¼Œä»å›è°ƒå‚æ•°è·å– code å’Œ state
result = await oauth_manager.oauth_login(
    provider="github",
    code=code_from_callback,
    ip_address=request.client.host,
    user_agent=request.headers.get("user-agent"),
)

# è¿”å› JWT ä»¤ç‰Œç»™ç”¨æˆ·
# {
#   "user": {...},
#   "access_token": "...",
#   "refresh_token": "...",
#   "provider": "github"
# }
```

#### å…³è” OAuth è´¦æˆ·

```python
from ModuleFolders.Service.Auth import get_oauth_manager

oauth_manager = get_oauth_manager()

# å·²ç™»å½•ç”¨æˆ·å…³è” GitHub è´¦æˆ·
result = oauth_manager.link_oauth_account(
    user_id=current_user.id,
    provider="github",
    oauth_id="github_user_id",
    access_token="github_access_token",
    account_data={
        "email": "user@example.com",
        "username": "githubuser",
        "name": "GitHub User",
        "avatar_url": "https://..."
    },
)
```

#### æŸ¥è¯¢å·²å…³è”è´¦æˆ·

```python
from ModuleFolders.Service.Auth import get_oauth_manager

oauth_manager = get_oauth_manager()

# è·å–ç”¨æˆ·æ‰€æœ‰å·²å…³è”çš„ OAuth è´¦æˆ·
accounts = oauth_manager.get_linked_accounts(user_id=current_user.id)

# [
#   {
#     "provider": "github",
#     "account_email": "user@example.com",
#     "account_username": "githubuser",
#     "linked_at": "2026-02-27T...",
#     "last_login_at": "2026-02-27T..."
#   },
#   {
#     "provider": "google",
#     ...
#   }
# ]
```

#### è§£é™¤å…³è”

```python
from ModuleFolders.Service.Auth import get_oauth_manager

oauth_manager = get_oauth_manager()

# è§£é™¤ GitHub è´¦æˆ·å…³è”
result = oauth_manager.unlink_oauth_account(
    user_id=current_user.id,
    provider="github",
)
```

#### 8. å®‰å…¨ç‰¹æ€§

**CSRF ä¿æŠ¤**
- ä½¿ç”¨ state å‚æ•°é˜²æ­¢ CSRF æ”»å‡»
- å»ºè®®å°† state å­˜å‚¨åœ¨ session ä¸­è¿›è¡ŒéªŒè¯

**ä»¤ç‰Œå®‰å…¨**
- OAuth è®¿é—®ä»¤ç‰Œå®‰å…¨å­˜å‚¨åœ¨æ•°æ®åº“
- æ”¯æŒä»¤ç‰Œè¿‡æœŸæ—¶é—´
- æ”¯æŒåˆ·æ–°ä»¤ç‰Œ

**è´¦æˆ·å®‰å…¨**
- OAuth è´¦æˆ·è‡ªåŠ¨é‚®ç®±éªŒè¯
- OAuth ç”¨æˆ·å¯ä»¥è®¾ç½®å¯†ç ï¼ˆæ”¯æŒæ··åˆç™»å½•ï¼‰
- é˜²æ­¢æœ€åä¸€ä¸ª OAuth è´¦æˆ·è¢«è§£ç»‘ï¼ˆéœ€å…ˆè®¾ç½®å¯†ç ï¼‰

#### 9. æ•°æ®åº“è¿ç§»

è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–ä»¥åˆ›å»º `oauth_accounts` è¡¨ï¼š

```python
from ModuleFolders.Service.Auth import init_database

db = init_database()
```

æˆ–ä½¿ç”¨è¿ç§»è„šæœ¬ï¼š

```sql
CREATE TABLE oauth_accounts (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    provider VARCHAR(50) NOT NULL,
    oauth_id VARCHAR(255) NOT NULL,
    access_token VARCHAR(500) NOT NULL,
    refresh_token VARCHAR(500),
    token_expires_at TIMESTAMP,
    account_email VARCHAR(255),
    account_username VARCHAR(255),
    account_data TEXT,
    linked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, provider),
    UNIQUE(provider, oauth_id)
);

CREATE INDEX idx_oauth_accounts_provider ON oauth_accounts(provider);
CREATE INDEX idx_oauth_accounts_oauth_id ON oauth_accounts(oauth_id);
```

#### 10. ä¾èµ–é¡¹

OAuth åŠŸèƒ½éœ€è¦ä»¥ä¸‹ä¾èµ–ï¼š
- `httpx` - å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ï¼ˆå·²åœ¨ pyproject.toml ä¸­ï¼‰
- `peewee` - ORMï¼ˆå·²åœ¨ pyproject.toml ä¸­ï¼‰

æ— éœ€é¢å¤–å®‰è£…ä¾èµ–ã€‚

#### 11. é”™è¯¯å¤„ç†

OAuth ç®¡ç†å™¨ä¼šæŠ›å‡º `OAuthError` å¼‚å¸¸ï¼ŒåŒ…å«ä»¥ä¸‹é”™è¯¯æƒ…å†µï¼š
- ä¸æ”¯æŒçš„ OAuth æä¾›å•†
- OAuth ä»¤ç‰Œäº¤æ¢å¤±è´¥
- OAuth ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥
- è´¦æˆ·å·²å­˜åœ¨æˆ–é‡å¤å…³è”
- å°è¯•è§£ç»‘æœ€åä¸€ä¸ª OAuth è´¦æˆ·

### é›†æˆè¯´æ˜

OAuth ç³»ç»Ÿä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- Auth models (ModuleFolders/Service/Auth/models.py)
- JWT Handler (ModuleFolders/Service/Auth/jwt_handler.py)
- Database (PostgreSQL/SQLite)

### ä¸‹ä¸€æ­¥

OAuth ç³»ç»Ÿå·²å®Œæˆï¼Œå¯ä»¥ï¼š
1. å®ç° API è·¯ç”±ï¼ˆ/api/v1/auth/oauth/github, /api/v1/auth/oauth/googleï¼‰
2. å®ç°å‰ç«¯ OAuth ç™»å½•æŒ‰é’®
3. å®ç°ç”¨æˆ·è´¦æˆ·ç®¡ç†ç•Œé¢ï¼ˆæ˜¾ç¤ºå·²å…³è”è´¦æˆ·ï¼Œæ”¯æŒè§£ç»‘ï¼‰

---

## æ€»ä½“è¿›åº¦

**æ•´ä½“å®Œæˆåº¦: 91%**

- è®¤è¯ç³»ç»Ÿ: 100% âœ… **å®Œæˆ**
- ç”¨æˆ·ç®¡ç†: 100% âœ… **å®Œæˆ**
- è®¢é˜…è®¡è´¹: 100% âœ… **å®Œæˆ**ï¼ˆStripe é›†æˆå®Œæˆï¼Œç”¨é‡è¿½è¸ªå’Œé…é¢æ‰§è¡Œå®Œæˆï¼Œè®¢é˜…ç®¡ç† API å®Œæˆï¼Œå‘ç¥¨ PDF ç”Ÿæˆå®Œæˆï¼Œç¼ºå‰ç«¯ï¼‰
- é«˜çº§åŠŸèƒ½: 30% (OAuth å®Œæˆï¼Œå›¢é˜Ÿç®¡ç†åŸºç¡€å®Œæˆï¼Œç¼ºå¤šç§Ÿæˆ·å’ŒSSO)

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - ç”¨é‡è¿½è¸ªä¸é…é¢æ‰§è¡Œç³»ç»Ÿ

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„ç”¨é‡è¿½è¸ªä¸é…é¢æ‰§è¡Œç³»ç»Ÿ

å®ç°äº†å®Œæ•´çš„ç”¨é‡è¿½è¸ªç³»ç»Ÿï¼ˆUsageTrackerï¼‰å’Œé…é¢æ‰§è¡Œä¸­é—´ä»¶ï¼ˆQuotaEnforcerï¼‰ï¼Œæ”¯æŒå¤šç§æŒ‡æ ‡ç±»å‹ã€ç¼“å­˜ä¼˜åŒ–å’Œ FastAPI é›†æˆã€‚

#### 1. UsageTracker (`ModuleFolders/Service/Billing/UsageTracker.py`)

å®Œæ•´çš„ç”¨é‡è¿½è¸ªæœåŠ¡ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

**æ”¯æŒçš„æŒ‡æ ‡ç±»å‹**
- `characters` - ç¿»è¯‘å­—ç¬¦æ•°
- `api_calls` - APIè°ƒç”¨æ¬¡æ•°
- `storage_mb` - å­˜å‚¨ä½¿ç”¨(MB)
- `concurrent_tasks` - å¹¶å‘ä»»åŠ¡æ•°
- `team_members` - å›¢é˜Ÿæˆå‘˜æ•°

**æ ¸å¿ƒæ–¹æ³•**
- `record_usage()` - è®°å½•ä½¿ç”¨äº‹ä»¶ï¼ˆæ”¯æŒå…ƒæ•°æ®ï¼‰
- `get_today_usage()` - ä»Šæ—¥ä½¿ç”¨é‡æŸ¥è¯¢
- `get_month_usage()` - æœ¬æœˆä½¿ç”¨é‡æŸ¥è¯¢

**é«˜çº§åˆ†æ**
- `get_usage_history()` - å†å²è®°å½•æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æ—¶é—´èŒƒå›´è¿‡æ»¤ï¼‰
- `get_daily_usage_stats()` - æ¯æ—¥ä½¿ç”¨ç»Ÿè®¡ï¼ˆç”¨äºè¶‹åŠ¿å›¾ï¼Œæ”¯æŒè‡ªå®šä¹‰å¤©æ•°ï¼‰
- `get_usage_summary()` - ä½¿ç”¨é‡æ±‡æ€»ï¼ˆä»Šæ—¥/æœ¬æœˆ/æ€»è®¡ï¼Œæ‰€æœ‰æŒ‡æ ‡ï¼‰

**ç®¡ç†åŠŸèƒ½**
- `get_top_users_by_usage()` - ä½¿ç”¨é‡æ’åï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
- `delete_old_records()` - æ—§æ•°æ®æ¸…ç†ï¼ˆæ•°æ®ä¿ç•™ç­–ç•¥ï¼‰

#### 2. QuotaEnforcer (`ModuleFolders/Service/Billing/QuotaEnforcer.py`)

å®Œæ•´çš„é…é¢æ‰§è¡Œä¸­é—´ä»¶ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

**é…é¢æ£€æŸ¥**
- `check_before_operation()` - æ“ä½œå‰é…é¢æ£€æŸ¥ï¼ˆæ”¯æŒé¢„ä¼°ä½¿ç”¨é‡ï¼‰
- `is_quota_available()` - ç®€å•é…é¢å¯ç”¨æ€§æ£€æŸ¥
- `get_usage_percentage()` - é…é¢ä½¿ç”¨ç™¾åˆ†æ¯”è®¡ç®—

**åŸå­æ“ä½œ**
- `record_and_check()` - è®°å½•ä½¿ç”¨é‡å¹¶è¿”å›æ›´æ–°åé…é¢
- `check_and_record()` - å…ˆæ£€æŸ¥åè®°å½•ï¼ˆåŸå­æ“ä½œï¼Œå¤±è´¥ä¸è®°å½•ï¼‰

**æ€§èƒ½ä¼˜åŒ–**
- é…é¢ç¼“å­˜æœºåˆ¶ï¼ˆé»˜è®¤60ç§’TTLï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
- è‡ªåŠ¨ç¼“å­˜å¤±æ•ˆï¼ˆè®°å½•ä½¿ç”¨åç«‹å³ä½¿ç¼“å­˜å¤±æ•ˆï¼‰

**é”™è¯¯å¤„ç†**
- `QuotaExceededError` - å®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯ï¼ˆåŒ…å«é™åˆ¶ã€å·²ç”¨ã€å‰©ä½™ã€å‡çº§é“¾æ¥ï¼‰
- è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯ï¼ˆä¸­æ–‡ï¼ŒåŒ…å«ä½¿ç”¨é‡å’Œå‡çº§å¼•å¯¼ï¼‰

**FastAPI é›†æˆ**
- `require_quota` è£…é¥°å™¨ - è‡ªåŠ¨æ£€æŸ¥é…é¢å¹¶è®°å½•ä½¿ç”¨é‡
- æ”¯æŒè‡ªå®šä¹‰æŒ‡æ ‡ç±»å‹å’Œä½¿ç”¨é‡å‚æ•°

#### 3. API ä½¿ç”¨ç¤ºä¾‹

**è®°å½•ä½¿ç”¨é‡**
```python
from ModuleFolders.Service.Billing import UsageTracker

tracker = UsageTracker()

# è®°å½•ç¿»è¯‘å­—ç¬¦æ•°
result = tracker.record_usage(
    user_id="user-123",
    metric_type="characters",
    quantity=1500,
    metadata={"task_id": "task-456", "source_lang": "en", "target_lang": "zh"},
)
```

**æŸ¥è¯¢ä½¿ç”¨å†å²**
```python
# è·å–æœ€è¿‘30å¤©çš„ä½¿ç”¨å†å²
history = tracker.get_usage_history(
    user_id="user-123",
    metric_type="characters",
    days=30,
    page=1,
    per_page=50,
)

# è¿”å›æ ¼å¼ï¼š
# {
#     "records": [...],
#     "pagination": {
#         "page": 1,
#         "per_page": 50,
#         "total_count": 150,
#         "total_pages": 3,
#         "has_next": true,
#         "has_prev": false,
#     }
# }
```

**è·å–æ¯æ—¥ç»Ÿè®¡ï¼ˆè¶‹åŠ¿å›¾ï¼‰**
```python
# è·å–æœ€è¿‘30å¤©çš„æ¯æ—¥ä½¿ç”¨ç»Ÿè®¡
daily_stats = tracker.get_daily_usage_stats(
    user_id="user-123",
    metric_type="characters",
    days=30,
)

# è¿”å›æ ¼å¼ï¼š
# [
#     {"date": "2026-02-01", "quantity": 5000},
#     {"date": "2026-02-02", "quantity": 3200},
#     ...
# ]
```

**é…é¢æ£€æŸ¥**
```python
from ModuleFolders.Service.Billing import QuotaEnforcer

enforcer = QuotaEnforcer()

# æ£€æŸ¥é…é¢
result = enforcer.check_before_operation(
    user_id="user-123",
    estimated_quantity=1000,
    metric_type="characters",
    raise_on_exceeded=True,  # è¶…é¢æ—¶æŠ›å‡ºå¼‚å¸¸
)

# è¿”å›æ ¼å¼ï¼š
# {
#     "allowed": true,
#     "remaining": 49000,
#     "limit": 50000,
#     "used": 1000,
#     "requested": 1000,
#     "exceeded": false,
# }
```

**ä½¿ç”¨è£…é¥°å™¨ï¼ˆFastAPI é›†æˆï¼‰**
```python
from ModuleFolders.Service.Billing import require_quota

@require_quota(metric_type="characters", quantity_param="char_count")
async def translate_text(user_id: str, char_count: int, text: str):
    # é…é¢æ£€æŸ¥é€šè¿‡åæ‰ä¼šæ‰§è¡Œæ­¤å‡½æ•°
    # æ‰§è¡Œå®Œæˆåè‡ªåŠ¨è®°å½•ä½¿ç”¨é‡
    result = await do_translation(text)
    return result
```

**å¤„ç†é…é¢è¶…é™**
```python
from ModuleFolders.Service.Billing import QuotaEnforcer, QuotaExceededError

enforcer = QuotaEnforcer()

try:
    enforcer.check_before_operation(
        user_id="user-123",
        estimated_quantity=10000,
        raise_on_exceeded=True,
    )
    # æ‰§è¡Œæ“ä½œ...
except QuotaExceededError as e:
    # è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    return {
        "error": e.to_dict(),
        # e.to_dict() è¿”å›ï¼š
        # {
        #     "error": "quota_exceeded",
        #     "message": "æ‚¨çš„ç¿»è¯‘å­—ç¬¦é…é¢å·²ç”¨å®Œ...",
        #     "limit": 50000,
        #     "used": 50000,
        #     "remaining": 0,
        #     "upgrade_url": "/pricing",
        # }
    }
```

#### 4. æ•°æ®åº“è¦æ±‚

éœ€è¦ `usage_records` è¡¨æ¥å­˜å‚¨ä½¿ç”¨è®°å½•ï¼š

```sql
CREATE TABLE usage_records (
    id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    metric_type VARCHAR(50) NOT NULL,
    quantity INTEGER NOT NULL,
    recorded_at TIMESTAMP NOT NULL,
    metadata TEXT,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_usage_records_user ON usage_records(user_id);
CREATE INDEX idx_usage_records_metric ON usage_records(metric_type);
CREATE INDEX idx_usage_records_date ON usage_records(date(recorded_at));
```

#### 5. é›†æˆè¯´æ˜

ç”¨é‡è¿½è¸ªå’Œé…é¢æ‰§è¡Œç³»ç»Ÿä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- SubscriptionManager (ModuleFolders/Service/Billing/SubscriptionManager.py)
- Database (ModuleFolders/Infrastructure/Database/pgsql.py)
- User/Tenant æ¨¡å‹ (ModuleFolders/Service/Auth/models.py)

### å®ç°å†…å®¹ï¼šç”¨æˆ·èµ„æ–™ç®¡ç†æœåŠ¡

åˆ›å»ºäº†å®Œæ•´çš„ User æœåŠ¡æ¨¡å— `ModuleFolders/Service/User/`:

#### 1. UserManager (`user_manager.py`)

ç”¨æˆ·ç®¡ç†å™¨æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

**ç”¨æˆ·èµ„æ–™ç®¡ç†**
- `get_profile(user_id)` - è·å–ç”¨æˆ·èµ„æ–™
- `update_profile(user_id, ...)` - æ›´æ–°ç”¨æˆ·èµ„æ–™ï¼ˆç”¨æˆ·åã€å…¨åã€ç®€ä»‹ã€å¤´åƒï¼‰
- `update_email(user_id, new_email, password)` - æ›´æ–°é‚®ç®±ï¼ˆéœ€å¯†ç éªŒè¯ï¼‰
- `update_password(user_id, current_password, new_password)` - æ›´æ–°å¯†ç 
- `delete_account(user_id, password)` - åˆ é™¤è´¦æˆ·

**ç®¡ç†å‘˜åŠŸèƒ½**
- `list_users(page, per_page, search, role, status)` - ç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢ã€è¿‡æ»¤ã€åˆ†é¡µï¼‰
- `update_user_role(admin_id, user_id, new_role)` - æ›´æ–°ç”¨æˆ·è§’è‰²
- `update_user_status(admin_id, user_id, new_status, reason)` - æ›´æ–°ç”¨æˆ·çŠ¶æ€

**å…¶ä»–åŠŸèƒ½**
- `get_login_history(user_id, page, per_page)` - ç™»å½•å†å²æŸ¥è¯¢
- `update_preferences(user_id, preferences)` - æ›´æ–°ç”¨æˆ·åå¥½
- `get_preferences(user_id)` - è·å–ç”¨æˆ·åå¥½

**éªŒè¯å™¨**
- `validate_username()` - ç”¨æˆ·åéªŒè¯ï¼ˆ3-20å­—ç¬¦ï¼Œå­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰
- `validate_full_name()` - å…¨åéªŒè¯
- `validate_bio()` - ç®€ä»‹éªŒè¯ï¼ˆæœ€å¤š500å­—ç¬¦ï¼‰
- `validate_avatar_url()` - å¤´åƒURLéªŒè¯

#### 2. UserRepository (`user_repository.py`)

æ•°æ®è®¿é—®å±‚æä¾›ï¼š
- `find_by_id()` - æŒ‰IDæŸ¥æ‰¾
- `find_by_email()` - æŒ‰é‚®ç®±æŸ¥æ‰¾
- `find_by_username()` - æŒ‰ç”¨æˆ·åæŸ¥æ‰¾
- `find_many()` - æ‰¹é‡æŸ¥è¯¢ï¼ˆæ”¯æŒè¿‡æ»¤å’Œåˆ†é¡µï¼‰
- `count()` - ç»Ÿè®¡ç”¨æˆ·æ•°é‡
- `create()` - åˆ›å»ºç”¨æˆ·
- `update()` - æ›´æ–°ç”¨æˆ·
- `delete()` - åˆ é™¤ç”¨æˆ·

#### 3. é‚®ä»¶é€šçŸ¥æ‰©å±• (`ModuleFolders/Service/Email/`)

æ–°å¢é‚®ä»¶æ¨¡æ¿å’Œå‘é€æ–¹æ³•ï¼š
- `send_email_change_notification()` - é‚®ç®±æ›´æ”¹é€šçŸ¥
- `send_password_change_notification()` - å¯†ç æ›´æ”¹é€šçŸ¥
- `send_account_deletion_notification()` - è´¦æˆ·åˆ é™¤é€šçŸ¥
- `send_role_change_notification()` - è§’è‰²æ›´æ”¹é€šçŸ¥
- `send_account_suspended_notification()` - è´¦æˆ·æš‚åœé€šçŸ¥
- `send_account_reactivated_notification()` - è´¦æˆ·é‡æ–°æ¿€æ´»é€šçŸ¥

### é›†æˆè¯´æ˜

User æœåŠ¡ä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- Auth models (ModuleFolders/Service/Auth/models.py)
- Password Manager (ModuleFolders/Service/Auth/password_manager.py)
- Email Service (ModuleFolders/Service/Email/email_service.py)

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - é‚®ç®±éªŒè¯æµç¨‹

### å®ç°å†…å®¹ï¼šé‚®ç®±éªŒè¯æµç¨‹

åœ¨ `ModuleFolders/Service/Auth/auth_manager.py` ä¸­æ·»åŠ äº†ä»¥ä¸‹æ–¹æ³•ï¼š

1. **`send_verification_email(user, verification_url_base)`**
   - ç”ŸæˆéªŒè¯ä»¤ç‰Œï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰
   - å­˜å‚¨ä»¤ç‰Œåˆ° EmailVerification è¡¨
   - å‘é€éªŒè¯é‚®ä»¶

2. **`verify_email(token)`**
   - éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
   - æ ‡è®°é‚®ç®±ä¸ºå·²éªŒè¯
   - å‘é€æ¬¢è¿é‚®ä»¶

3. **`resend_verification_email(email, verification_url_base)`**
   - é‡å‘éªŒè¯é‚®ä»¶
   - é˜²æ­¢é‚®ä»¶æšä¸¾æ”»å‡»
   - æ£€æŸ¥æ˜¯å¦å·²éªŒè¯æˆ–å·²å‘é€

4. **`verify_verification_token(token)`**
   - ä»…éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§ï¼Œä¸æ‰§è¡ŒéªŒè¯æ“ä½œ

5. **æ›´æ–° `register()` æ–¹æ³•**
   - æ·»åŠ  `send_verification` å‚æ•°
   - æ³¨å†Œæ—¶è‡ªåŠ¨å‘é€éªŒè¯é‚®ä»¶

### é›†æˆè¯´æ˜

é‚®ç®±éªŒè¯æµç¨‹ä¾èµ–ä»¥ä¸‹æœåŠ¡ï¼š
- EmailService (ModuleFolders/Service/Email/)
- EmailVerification æ¨¡å‹ (ModuleFolders/Service/Auth/models.py)

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - Stripe æ”¯ä»˜é›†æˆ

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„ Stripe æ”¯ä»˜é›†æˆ

å®ç°äº†å®Œæ•´çš„ Stripe æ”¯ä»˜å¤„ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ Webhook å¤„ç†ã€æ”¯ä»˜æ–¹å¼ç®¡ç†ã€è®¢é˜…ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œé‚®ä»¶é€šçŸ¥ã€‚

#### 1. StripeWebhookHandler (`ModuleFolders/Service/Billing/stripe_webhook.py`)

å®Œæ•´çš„ Stripe Webhook äº‹ä»¶å¤„ç†å™¨ï¼Œæ”¯æŒï¼š

**Webhook ç­¾åéªŒè¯**
- `verify_signature()` - éªŒè¯ Stripe ç­¾åï¼Œé˜²æ­¢ä¼ªé€ è¯·æ±‚

**æ”¯ä»˜äº‹ä»¶å¤„ç†**
- `handle_payment_succeeded()` - å¤„ç†æ”¯ä»˜æˆåŠŸï¼Œè®°å½•åˆ°æ•°æ®åº“ï¼Œå‘é€é€šçŸ¥é‚®ä»¶
- `handle_payment_failed()` - å¤„ç†æ”¯ä»˜å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯ï¼Œå‘é€å¤±è´¥é€šçŸ¥
- `handle_checkout_completed()` - å¤„ç†ç»“è´¦ä¼šè¯å®Œæˆï¼Œå…³è”ç”¨æˆ·å’Œå®¢æˆ·

**è®¢é˜…äº‹ä»¶å¤„ç†**
- `handle_subscription_updated()` - å¤„ç†è®¢é˜…æ›´æ–°ï¼ˆå‡é™çº§ï¼‰ï¼Œæ›´æ–°ç§Ÿæˆ·è®¡åˆ’
- `handle_subscription_deleted()` - å¤„ç†è®¢é˜…å–æ¶ˆï¼Œé™çº§ä¸ºå…è´¹è®¡åˆ’

**å‘ç¥¨äº‹ä»¶å¤„ç†**
- `handle_invoice_paid()` - å¤„ç†å‘ç¥¨æ”¯ä»˜æˆåŠŸï¼Œæ›´æ–°å‘ç¥¨çŠ¶æ€
- `handle_invoice_payment_failed()` - å¤„ç†å‘ç¥¨æ”¯ä»˜å¤±è´¥ï¼Œè®°å½•é‡è¯•æ¬¡æ•°

**è¾…åŠ©æ–¹æ³•**
- `_find_user_by_customer_id()` - æ ¹æ® Stripe å®¢æˆ· ID æŸ¥æ‰¾ç”¨æˆ·
- `_map_price_to_plan()` - å°† Stripe Price ID æ˜ å°„åˆ°è®¢é˜…è®¡åˆ’

#### 2. PaymentProcessor å¢å¼º (`ModuleFolders/Service/Billing/PaymentProcessor.py`)

æ–°å¢å®Œæ•´çš„ Stripe API é›†æˆæ–¹æ³•ï¼š

**æ”¯ä»˜æ–¹å¼ç®¡ç†**
- `get_payment_methods(customer_id)` - è·å–å®¢æˆ·çš„æ‰€æœ‰æ”¯ä»˜æ–¹å¼
- `attach_payment_method()` - å°†æ”¯ä»˜æ–¹å¼é™„åŠ åˆ°å®¢æˆ·
- `detach_payment_method()` - åˆ†ç¦»æ”¯ä»˜æ–¹å¼
- `set_default_payment_method()` - è®¾ç½®é»˜è®¤æ”¯ä»˜æ–¹å¼

**è®¢é˜…ç®¡ç†**
- `create_subscription()` - åˆ›å»ºè®¢é˜…ï¼ˆæ”¯æŒè¯•ç”¨ï¼‰
- `cancel_subscription()` - å–æ¶ˆè®¢é˜…ï¼ˆç«‹å³æˆ–å‘¨æœŸç»“æŸï¼‰
- `update_subscription()` - æ›´æ–°è®¢é˜…è®¡åˆ’ï¼ˆå‡é™çº§ï¼‰
- `get_subscription()` - è·å–è®¢é˜…è¯¦æƒ…

**å‘ç¥¨ç®¡ç†**
- `get_invoice()` - è·å–å‘ç¥¨è¯¦æƒ…ï¼ˆå« PDF ä¸‹è½½é“¾æ¥ï¼‰
- `list_invoices()` - è·å–å®¢æˆ·çš„å‘ç¥¨åˆ—è¡¨

#### 3. é‚®ä»¶é€šçŸ¥æ‰©å±• (`ModuleFolders/Service/Email/`)

**æ–°å¢é‚®ä»¶æ¨¡æ¿** (`templates.py`)
- `get_payment_notification_template()` - æ”¯ä»˜æˆåŠŸ/å¤±è´¥é€šçŸ¥æ¨¡æ¿
- `get_subscription_notification_template()` - è®¢é˜…æ›´æ–°/å–æ¶ˆé€šçŸ¥æ¨¡æ¿
- `get_invoice_notification_template()` - å‘ç¥¨æ”¯ä»˜/å¤±è´¥é€šçŸ¥æ¨¡æ¿

**æ–°å¢å‘é€æ–¹æ³•** (`email_service.py`)
- `send_payment_notification()` - å‘é€æ”¯ä»˜é€šçŸ¥
- `send_subscription_notification()` - å‘é€è®¢é˜…é€šçŸ¥
- `send_invoice_notification()` - å‘é€å‘ç¥¨é€šçŸ¥

### æ”¯æŒçš„ Stripe äº‹ä»¶

| äº‹ä»¶ç±»å‹ | å¤„ç†æ–¹æ³• | åŠŸèƒ½ |
|----------|----------|------|
| `payment_intent.succeeded` | `_handle_payment_succeeded` | æ”¯ä»˜æˆåŠŸå¤„ç† |
| `payment_intent.payment_failed` | `_handle_payment_failed` | æ”¯ä»˜å¤±è´¥å¤„ç† |
| `customer.subscription.updated` | `_handle_subscription_updated` | è®¢é˜…æ›´æ–°å¤„ç† |
| `customer.subscription.deleted` | `_handle_subscription_deleted` | è®¢é˜…å–æ¶ˆå¤„ç† |
| `invoice.payment_failed` | `_handle_invoice_payment_failed` | å‘ç¥¨æ”¯ä»˜å¤±è´¥å¤„ç† |
| `invoice.paid` | `_handle_invoice_paid` | å‘ç¥¨å·²æ”¯ä»˜å¤„ç† |
| `checkout.session.completed` | `_handle_checkout_completed` | ç»“è´¦å®Œæˆå¤„ç† |

### éœ€è¦çš„æ•°æ®åº“è¡¨

ä¸ºæ”¯æŒ Stripe é›†æˆï¼Œéœ€è¦åˆ›å»ºä»¥ä¸‹æ•°æ®åº“è¡¨ï¼š

```sql
-- æ”¯ä»˜è®°å½•è¡¨
CREATE TABLE payments (
    id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    stripe_payment_id VARCHAR(255) NOT NULL,
    amount DECIMAL(10, 2),
    currency VARCHAR(3),
    status VARCHAR(50),
    error_message TEXT,
    created_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- è®¢é˜…äº‹ä»¶è®°å½•è¡¨
CREATE TABLE subscription_events (
    id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    subscription_id VARCHAR(255) NOT NULL,
    event_type VARCHAR(50),
    plan VARCHAR(50),
    status VARCHAR(50),
    created_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- ç»“è´¦ä¼šè¯è®°å½•è¡¨
CREATE TABLE checkout_sessions (
    id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    stripe_session_id VARCHAR(255) NOT NULL,
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    status VARCHAR(50),
    created_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### ç¯å¢ƒå˜é‡é…ç½®

éœ€è¦åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
# Stripe API é…ç½®
STRIPE_API_KEY=sk_test_...              # Stripe API å¯†é’¥
STRIPE_WEBHOOK_SECRET=whsec_...         # Webhook ç­¾åå¯†é’¥

# Stripe Price IDs
STRIPE_PRICE_STARTER=price_...          # å…¥é—¨è®¡åˆ’ Price ID
STRIPE_PRICE_PRO=price_...              # ä¸“ä¸šè®¡åˆ’ Price ID
STRIPE_PRICE_ENTERPRISE=price_...       # ä¼ä¸šè®¡åˆ’ Price ID
```

### ä¾èµ–å®‰è£…

```bash
pip install stripe
```

### API ä½¿ç”¨ç¤ºä¾‹

#### åˆ›å»ºç»“è´¦ä¼šè¯

```python
from ModuleFolders.Service.Billing import PaymentProcessor

processor = PaymentProcessor()

# åˆ›å»ºç»“è´¦ä¼šè¯
session = processor.create_checkout_session(
    user_id="user-123",
    plan=SubscriptionPlan.PRO,
    success_url="https://example.com/success",
    cancel_url="https://example.com/cancel",
)

# é‡å®šå‘ç”¨æˆ·åˆ° session['url'] è¿›è¡Œæ”¯ä»˜
```

#### å¤„ç† Webhook

```python
from ModuleFolders.Service.Billing import StripeWebhookHandler

handler = StripeWebhookHandler()

# éªŒè¯ç­¾å
if handler.verify_signature(payload, signature):
    # è§£æäº‹ä»¶
    event_data = json.loads(payload)
    # å¤„ç†äº‹ä»¶
    result = handler.handle_event(event_data)
```

### é›†æˆè¯´æ˜

Stripe é›†æˆä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- Stripe Python SDK (`stripe` åŒ…)
- EmailService (ModuleFolders/Service/Email/)
- User/Tenant æ¨¡å‹ (ModuleFolders/Service/Auth/models.py)
- æ•°æ®åº“ (PostgreSQL/SQLite)

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - ç”¨æˆ·ç®¡ç† API è·¯ç”±

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„ç”¨æˆ·ç®¡ç† API è·¯ç”±ç³»ç»Ÿ

åœ¨ `Tools/WebServer/web_server.py` ä¸­å®ç°äº† 12 ä¸ªç”¨æˆ·ç®¡ç† API è·¯ç”±ï¼ŒåŒ…æ‹¬å½“å‰ç”¨æˆ·æ“ä½œå’Œç®¡ç†å‘˜åŠŸèƒ½ã€‚

#### 1. å½“å‰ç”¨æˆ· API (8ä¸ªè·¯ç”±)

**ç”¨æˆ·èµ„æ–™ç®¡ç†**
- `GET /api/v1/users/me` - è·å–å½“å‰ç”¨æˆ·èµ„æ–™
  - è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼ˆé‚®ç®±ã€ç”¨æˆ·åã€è§’è‰²ã€çŠ¶æ€ã€å…¨åã€ç®€ä»‹ã€å¤´åƒç­‰ï¼‰
  - åŒ…å«é‚®ç®±éªŒè¯çŠ¶æ€å’Œæœ€åç™»å½•æ—¶é—´

- `PUT /api/v1/users/me` - æ›´æ–°ç”¨æˆ·èµ„æ–™
  - æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼ˆç”¨æˆ·åã€å…¨åã€ç®€ä»‹ã€å¤´åƒï¼‰
  - è‡ªåŠ¨éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
  - å­—æ®µé•¿åº¦éªŒè¯ï¼ˆç®€ä»‹æœ€å¤š 500 å­—ç¬¦ï¼‰

- `PUT /api/v1/users/me/email` - æ›´æ–°é‚®ç®±
  - éœ€è¦å¯†ç éªŒè¯
  - æ–°é‚®ç®±å¿…é¡»å”¯ä¸€
  - è‡ªåŠ¨å‘é€éªŒè¯é‚®ä»¶åˆ°æ–°é‚®ç®±
  - å‘é€é€šçŸ¥åˆ°æ—§é‚®ç®±

- `PUT /api/v1/users/me/password` - æ›´æ–°å¯†ç 
  - éœ€è¦å½“å‰å¯†ç éªŒè¯
  - è‡ªåŠ¨æ’¤é”€æ‰€æœ‰åˆ·æ–°ä»¤ç‰Œï¼ˆå¼ºåˆ¶é‡æ–°ç™»å½•ï¼‰
  - å‘é€å¯†ç æ›´æ”¹é€šçŸ¥é‚®ä»¶

- `DELETE /api/v1/users/me` - åˆ é™¤è´¦æˆ·
  - éœ€è¦å¯†ç ç¡®è®¤ï¼ˆå¦‚æœç”¨æˆ·æœ‰å¯†ç ï¼‰
  - æ­¤æ“ä½œä¸å¯æ’¤é”€
  - å‘é€è´¦æˆ·åˆ é™¤é€šçŸ¥é‚®ä»¶

**åå¥½è®¾ç½®**
- `GET /api/v1/users/me/preferences` - è·å–ç”¨æˆ·åå¥½
  - è¿”å›ç”¨æˆ·çš„è‡ªå®šä¹‰è®¾ç½®

- `PUT /api/v1/users/me/preferences` - æ›´æ–°ç”¨æˆ·åå¥½
  - å…è®¸å­˜å‚¨ä»»æ„ JSON æ ¼å¼çš„ç”¨æˆ·è®¾ç½®

**ç™»å½•å†å²**
- `GET /api/v1/users/me/login-history` - è·å–ç™»å½•å†å²
  - æ”¯æŒåˆ†é¡µï¼ˆpage, per_pageï¼‰
  - åŒ…å« IP åœ°å€ã€User Agentã€æˆåŠŸ/å¤±è´¥çŠ¶æ€ã€æ—¶é—´æˆ³

#### 2. ç®¡ç†å‘˜ API (4ä¸ªè·¯ç”±)

- `GET /api/v1/users` - è·å–ç”¨æˆ·åˆ—è¡¨
  - æ”¯æŒåˆ†é¡µï¼ˆpage, per_pageï¼Œé»˜è®¤ 1é¡µ20æ¡ï¼‰
  - æ”¯æŒæœç´¢ï¼ˆåœ¨ç”¨æˆ·åå’Œé‚®ç®±ä¸­æœç´¢ï¼‰
  - æ”¯æŒæŒ‰è§’è‰²è¿‡æ»¤ï¼ˆsuper_admin, tenant_admin, team_admin, translation_admin, developer, userï¼‰
  - æ”¯æŒæŒ‰çŠ¶æ€è¿‡æ»¤ï¼ˆactive, inactive, suspendedï¼‰

- `GET /api/v1/users/{user_id}` - è·å–ç”¨æˆ·è¯¦æƒ…
  - è¿”å›æŒ‡å®šç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯

- `PUT /api/v1/users/{user_id}/role` - æ›´æ–°ç”¨æˆ·è§’è‰²
  - æ”¯æŒ 6 ç§è§’è‰²ï¼ˆsuper_admin, tenant_admin, team_admin, translation_admin, developer, userï¼‰
  - å‘é€è§’è‰²æ›´æ”¹é€šçŸ¥é‚®ä»¶

- `PUT /api/v1/users/{user_id}/status` - æ›´æ–°ç”¨æˆ·çŠ¶æ€
  - æ”¯æŒ 3 ç§çŠ¶æ€ï¼ˆactive, inactive, suspendedï¼‰
  - å¯é€‰åŸå› å­—æ®µç”¨äºå®¡è®¡
  - å‘é€çŠ¶æ€æ›´æ”¹é€šçŸ¥é‚®ä»¶

#### 3. å®‰å…¨ç‰¹æ€§

**è®¤è¯å’Œæˆæƒ**
- æ‰€æœ‰è·¯ç”±ä½¿ç”¨ JWT è®¤è¯ï¼ˆ`jwt_middleware.get_current_user`ï¼‰
- ç®¡ç†å‘˜è·¯ç”±ä½¿ç”¨æƒé™ä¸­é—´ä»¶ï¼ˆ`jwt_middleware.require_admin()`ï¼‰
- OAuth ç”¨æˆ·å¯ä»¥è®¾ç½®å¯†ç ä»¥æ”¯æŒå¯†ç ç™»å½•

**å¯†ç å®‰å…¨**
- æ•æ„Ÿæ“ä½œéœ€è¦å¯†ç éªŒè¯ï¼ˆé‚®ç®±æ›´æ”¹ã€å¯†ç æ›´æ”¹ã€è´¦æˆ·åˆ é™¤ï¼‰
- å¯†ç æ›´æ”¹åè‡ªåŠ¨æ’¤é”€æ‰€æœ‰åˆ·æ–°ä»¤ç‰Œ
- OAuth ç”¨æˆ·å¦‚æœæœªè®¾ç½®å¯†ç ï¼Œåˆ é™¤è´¦æˆ·æ—¶ä¸éœ€è¦å¯†ç ç¡®è®¤

**é”™è¯¯å¤„ç†**
- é€‚å½“çš„ HTTP çŠ¶æ€ç ï¼ˆ200, 400, 404, 500ï¼‰
- å‹å¥½çš„ä¸­æ–‡é”™è¯¯æ¶ˆæ¯
- å‚æ•°éªŒè¯å¤±è´¥æ—¶è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯

#### 4. API ä½¿ç”¨ç¤ºä¾‹

**è·å–å½“å‰ç”¨æˆ·èµ„æ–™**
```bash
curl -X GET "http://localhost:8000/api/v1/users/me" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**æ›´æ–°ç”¨æˆ·èµ„æ–™**
```bash
curl -X PUT "http://localhost:8000/api/v1/users/me" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"full_name": "å¼ ä¸‰", "bio": "è¿™æ˜¯æˆ‘çš„ç®€ä»‹"}'
```

**æ›´æ–°å¯†ç **
```bash
curl -X PUT "http://localhost:8000/api/v1/users/me/password" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"current_password": "oldpassword", "new_password": "newpassword123"}'
```

**ç®¡ç†å‘˜è·å–ç”¨æˆ·åˆ—è¡¨**
```bash
curl -X GET "http://localhost:8000/api/v1/users?page=1&per_page=20&search=zhang&role=user&status=active" \
  -H "Authorization: Bearer ADMIN_ACCESS_TOKEN"
```

**ç®¡ç†å‘˜æ›´æ–°ç”¨æˆ·è§’è‰²**
```bash
curl -X PUT "http://localhost:8000/api/v1/users/user-123/role" \
  -H "Authorization: Bearer ADMIN_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"new_role": "developer"}'
```

#### 5. ä¾èµ–æ¨¡å—

ç”¨æˆ·ç®¡ç† API è·¯ç”±ä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- UserManager (`ModuleFolders/Service/User/user_manager.py`)
- UserRepository (`ModuleFolders/Service/User/user_repository.py`)
- JWT Middleware (`ModuleFolders/Service/Auth/auth_middleware.py`)
- Email Service (`ModuleFolders/Service/Email/email_service.py`)
- User Model (`ModuleFolders/Service/Auth/models.py`)

#### 6. æµ‹è¯•éªŒè¯

- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… FastAPI åº”ç”¨åŠ è½½æˆåŠŸ
- âœ… 12 ä¸ªç”¨æˆ·ç®¡ç†è·¯ç”±æ³¨å†ŒæˆåŠŸ
- âœ… æ‰€æœ‰è·¯ç”±ä½¿ç”¨æ­£ç¡®çš„ HTTP æ–¹æ³•
- âœ… è¯·æ±‚/å“åº”æ¨¡å‹å®šä¹‰å®Œæ•´

### é›†æˆè¯´æ˜

ç”¨æˆ·ç®¡ç† API å·²å®Œå…¨é›†æˆåˆ° WebServerï¼Œå¯ä»¥é€šè¿‡ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£è®¿é—®ï¼š
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### ä¸‹ä¸€æ­¥

ç”¨æˆ·ç®¡ç† API å·²å®Œæˆï¼Œå¯ä»¥ï¼š
1. å®ç°è®¢é˜…ç®¡ç† API è·¯ç”±
2. å®ç°ç”¨é‡ç®¡ç† API è·¯ç”±
3. å®ç°å‰ç«¯ç”¨æˆ·ç®¡ç†ç•Œé¢

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - è®¢é˜…ç®¡ç† API è·¯ç”±

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„è®¢é˜…ç®¡ç† API è·¯ç”±ç³»ç»Ÿ

åœ¨ `Tools/WebServer/web_server.py` ä¸­å®ç°äº† 7 ä¸ªè®¢é˜…ç®¡ç† API è·¯ç”±ï¼ŒåŒ…æ‹¬è®¢é˜…åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€å–æ¶ˆå’Œå‘ç¥¨ç®¡ç†ã€‚

#### 1. è¯·æ±‚/å“åº”æ¨¡å‹ (3ä¸ª)

**è®¢é˜…ç®¡ç†æ¨¡å‹**:
- `CreateSubscriptionRequest` - åˆ›å»ºè®¢é˜…è¯·æ±‚ï¼ˆè®¡åˆ’ã€æˆåŠŸ/å–æ¶ˆ URLï¼‰
- `UpdateSubscriptionRequest` - æ›´æ–°è®¢é˜…è¯·æ±‚ï¼ˆæ–°è®¡åˆ’ï¼‰
- `CancelSubscriptionRequest` - å–æ¶ˆè®¢é˜…è¯·æ±‚ï¼ˆæ˜¯å¦åœ¨å‘¨æœŸç»“æŸæ—¶å–æ¶ˆï¼‰

#### 2. è®¢é˜…ç®¡ç† API (7ä¸ªè·¯ç”±)

**è®¢é˜…è®¡åˆ’**:
- `GET /api/v1/subscriptions/plans` - è·å–æ‰€æœ‰è®¢é˜…è®¡åˆ’
  - è¿”å›æ‰€æœ‰è®¡åˆ’çš„è¯¦ç»†ä¿¡æ¯ï¼ˆè®¡åˆ’åç§°ã€æ¯æ—¥å­—ç¬¦æ•°é™åˆ¶ã€æœˆè´¹ä»·æ ¼ã€åŠŸèƒ½åˆ—è¡¨ï¼‰
  - æ— éœ€è®¤è¯

**è®¢é˜…ç®¡ç†**:
- `POST /api/v1/subscriptions` - åˆ›å»ºæ–°è®¢é˜…
  - åˆ›å»ºè®¢é˜…å¹¶è¿”å› Stripe Checkout Session URL
  - ç”¨æˆ·è®¿é—®è¿”å›çš„ URL å®Œæˆæ”¯ä»˜
  - Free è®¡åˆ’æ— éœ€æ”¯ä»˜æµç¨‹

- `GET /api/v1/subscriptions/current` - è·å–å½“å‰è®¢é˜…
  - è¿”å›å½“å‰ç”¨æˆ·çš„è®¢é˜…è¯¦æƒ…ï¼ˆè®¡åˆ’ã€çŠ¶æ€ã€è¿‡æœŸæ—¶é—´ã€Stripe IDï¼‰
  - æ— ç§Ÿæˆ·çš„ç”¨æˆ·é»˜è®¤è¿”å› Free è®¡åˆ’

- `PUT /api/v1/subscriptions/current` - æ›´æ–°è®¢é˜…ï¼ˆå‡é™çº§ï¼‰
  - æ”¯æŒä» starter å‡çº§åˆ° pro
  - æ”¯æŒä» pro é™çº§åˆ° starter
  - æ”¯æŒåˆ‡æ¢åˆ° enterprise
  - æ— æ³•é™çº§åˆ° Freeï¼ˆéœ€ä½¿ç”¨å–æ¶ˆè®¢é˜…ï¼‰

- `DELETE /api/v1/subscriptions/current` - å–æ¶ˆè®¢é˜…
  - å¯é€‰æ‹©åœ¨å½“å‰è®¡è´¹å‘¨æœŸç»“æŸæ—¶å–æ¶ˆï¼ˆé»˜è®¤ï¼‰
  - æˆ–ç«‹å³å–æ¶ˆè®¢é˜…
  - å–æ¶ˆåè®¢é˜…å°†é™çº§åˆ° Free è®¡åˆ’

**å‘ç¥¨ç®¡ç†**:
- `GET /api/v1/subscriptions/invoices` - è·å–å‘ç¥¨åˆ—è¡¨
  - è¿”å›å½“å‰ç”¨æˆ·çš„å‘ç¥¨åˆ—è¡¨
  - æ”¯æŒé™åˆ¶è¿”å›æ•°é‡ï¼ˆé»˜è®¤ 12 æ¡ï¼‰
  - åŒ…å«å‘ç¥¨ç¼–å·ã€çŠ¶æ€ã€é‡‘é¢ã€åˆ›å»ºæ—¶é—´ç­‰ä¿¡æ¯

- `GET /api/v1/subscriptions/invoices/{invoice_id}` - è·å–å‘ç¥¨è¯¦æƒ…
  - è¿”å›æŒ‡å®šå‘ç¥¨çš„è¯¦ç»†ä¿¡æ¯
  - åŒ…å« PDF ä¸‹è½½é“¾æ¥å’Œå‘ç¥¨æ‰˜ç®¡é¡µé¢ URL

#### 3. API ä½¿ç”¨ç¤ºä¾‹

**è·å–è®¢é˜…è®¡åˆ’**
```bash
curl -X GET "http://localhost:8000/api/v1/subscriptions/plans"
```

**åˆ›å»ºè®¢é˜…**
```bash
curl -X POST "http://localhost:8000/api/v1/subscriptions" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "plan": "pro",
    "success_url": "http://localhost:8000/billing/success",
    "cancel_url": "http://localhost:8000/billing/cancel"
  }'
```

**è·å–å½“å‰è®¢é˜…**
```bash
curl -X GET "http://localhost:8000/api/v1/subscriptions/current" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**æ›´æ–°è®¢é˜…ï¼ˆå‡é™çº§ï¼‰**
```bash
curl -X PUT "http://localhost:8000/api/v1/subscriptions/current" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"new_plan": "pro"}'
```

**å–æ¶ˆè®¢é˜…**
```bash
curl -X DELETE "http://localhost:8000/api/v1/subscriptions/current" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"at_period_end": true}'
```

**è·å–å‘ç¥¨åˆ—è¡¨**
```bash
curl -X GET "http://localhost:8000/api/v1/subscriptions/invoices?limit=12" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**è·å–å‘ç¥¨è¯¦æƒ…**
```bash
curl -X GET "http://localhost:8000/api/v1/subscriptions/invoices/in_1234567890" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

#### 4. å®‰å…¨ç‰¹æ€§

**è®¤è¯å’Œæˆæƒ**
- æ‰€æœ‰è·¯ç”±ï¼ˆé™¤è·å–è®¡åˆ’åˆ—è¡¨å¤–ï¼‰ä½¿ç”¨ JWT è®¤è¯
- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„è®¢é˜…ä¿¡æ¯
- Stripe å®¢æˆ· ID ä¸ç”¨æˆ·å…³è”éªŒè¯

**é”™è¯¯å¤„ç†**
- è®¡åˆ’éªŒè¯ï¼ˆé˜²æ­¢æ— æ•ˆçš„è®¡åˆ’å€¼ï¼‰
- è®¢é˜…çŠ¶æ€æ£€æŸ¥ï¼ˆæ— æ´»è·ƒè®¢é˜…æ—¶æ‹’ç»æ“ä½œï¼‰
- ç§Ÿæˆ·éªŒè¯ï¼ˆç¡®ä¿ç”¨æˆ·æœ‰ç§Ÿæˆ·ä¿¡æ¯ï¼‰
- å‹å¥½çš„ä¸­æ–‡é”™è¯¯æ¶ˆæ¯

**Stripe é›†æˆ**
- è‡ªåŠ¨åˆ›å»º Stripe å®¢æˆ·
- æ”¯æŒå¤šç§è®¢é˜…è®¡åˆ’ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡é…ç½® Price IDï¼‰
- å®Œæ•´çš„è®¢é˜…ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 5. ç¯å¢ƒå˜é‡é…ç½®

éœ€è¦åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
# Stripe API é…ç½®
STRIPE_API_KEY=sk_test_...              # Stripe API å¯†é’¥
STRIPE_WEBHOOK_SECRET=whsec_...         # Webhook ç­¾åå¯†é’¥

# Stripe Price IDs
STRIPE_PRICE_STARTER=price_...          # å…¥é—¨è®¡åˆ’ Price ID
STRIPE_PRICE_PRO=price_...              # ä¸“ä¸šè®¡åˆ’ Price ID
STRIPE_PRICE_ENTERPRISE=price_...       # ä¼ä¸šè®¡åˆ’ Price ID
```

#### 6. ä¾èµ–æ¨¡å—

è®¢é˜…ç®¡ç† API è·¯ç”±ä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- SubscriptionManager (`ModuleFolders/Service/Billing/SubscriptionManager.py`)
- PaymentProcessor (`ModuleFolders/Service/Billing/PaymentProcessor.py`)
- Tenant æ¨¡å‹ (`ModuleFolders/Service/Auth/models.py`)
- JWT Middleware (`ModuleFolders/Service/Auth/auth_middleware.py`)

#### 7. æµ‹è¯•éªŒè¯

- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… FastAPI åº”ç”¨åŠ è½½æˆåŠŸ
- âœ… 7 ä¸ªè®¢é˜…ç®¡ç†è·¯ç”±æ³¨å†ŒæˆåŠŸ
- âœ… æ‰€æœ‰è·¯ç”±ä½¿ç”¨æ­£ç¡®çš„ HTTP æ–¹æ³•
- âœ… è¯·æ±‚/å“åº”æ¨¡å‹å®šä¹‰å®Œæ•´

### é›†æˆè¯´æ˜

è®¢é˜…ç®¡ç† API å·²å®Œå…¨é›†æˆåˆ° WebServerï¼Œå¯ä»¥é€šè¿‡ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£è®¿é—®ï¼š
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### ä¸‹ä¸€æ­¥

è®¢é˜…ç®¡ç† API å·²å®Œæˆï¼Œå¯ä»¥ï¼š
1. å®ç°ç”¨é‡ç®¡ç† API è·¯ç”±
2. å®ç° OAuth API è·¯ç”±
3. å®ç°å‰ç«¯è®¢é˜…ç®¡ç†ç•Œé¢

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - ç”¨é‡ç®¡ç† API è·¯ç”±

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„ç”¨é‡ç®¡ç† API è·¯ç”±ç³»ç»Ÿ

åœ¨ `Tools/WebServer/web_server.py` ä¸­å®ç°äº† 3 ä¸ªç”¨é‡ç®¡ç† API è·¯ç”±ï¼ŒåŒ…æ‹¬å½“å‰ç”¨é‡æ±‡æ€»ã€å†å²è®°å½•æŸ¥è¯¢å’Œæ¯æ—¥è¶‹åŠ¿ç»Ÿè®¡ã€‚

#### 1. ç”¨é‡ç®¡ç† API (3ä¸ªè·¯ç”±)

**å½“å‰ç”¨é‡æ±‡æ€»**
- `GET /api/v1/usage/current` - è·å–å½“å‰ç”¨æˆ·çš„ç”¨é‡æ±‡æ€»
  - è¿”å›ä»Šæ—¥ã€æœ¬æœˆå’Œæ€»è®¡çš„ä½¿ç”¨é‡
  - åŒ…å«æ‰€æœ‰æŒ‡æ ‡ç±»å‹ï¼ˆcharacters, api_calls, storage_mb, concurrent_tasks, team_membersï¼‰
  - éœ€è¦è®¤è¯ï¼ˆJWT Tokenï¼‰

**ç”¨é‡å†å²è®°å½•**
- `GET /api/v1/usage/history` - è·å–ç”¨æˆ·ä½¿ç”¨å†å²è®°å½•ï¼ˆåˆ†é¡µï¼‰
  - æ”¯æŒæŒ‰æŒ‡æ ‡ç±»å‹è¿‡æ»¤
  - æ”¯æŒæ—¥æœŸèŒƒå›´è¿‡æ»¤
  - åˆ†é¡µæŸ¥è¯¢ï¼ˆé»˜è®¤æ¯é¡µ50æ¡ï¼Œæœ€å¤§100æ¡ï¼‰
  - è¿”å›è®°å½•åˆ—è¡¨å’Œåˆ†é¡µä¿¡æ¯
  - éœ€è¦è®¤è¯ï¼ˆJWT Tokenï¼‰

**æ¯æ—¥ç”¨é‡ç»Ÿè®¡**
- `GET /api/v1/usage/daily` - è·å–æ¯æ—¥ä½¿ç”¨é‡ç»Ÿè®¡ï¼ˆç”¨äºè¶‹åŠ¿å›¾ï¼‰
  - æ”¯æŒé€‰æ‹©æŒ‡æ ‡ç±»å‹ï¼ˆé»˜è®¤: charactersï¼‰
  - å¯è®¾ç½®ç»Ÿè®¡å¤©æ•°ï¼ˆé»˜è®¤30å¤©ï¼Œæœ€å¤§90å¤©ï¼‰
  - è‡ªåŠ¨å¡«å……ç¼ºå¤±æ—¥æœŸï¼ˆä½¿ç”¨é‡ä¸º0ï¼‰
  - è¿”å›æŒ‰æ—¥æœŸæ’åºçš„æ¯æ—¥ç”¨é‡åˆ—è¡¨
  - éœ€è¦è®¤è¯ï¼ˆJWT Tokenï¼‰

#### 2. API åŠŸèƒ½ç‰¹æ€§

**æŒ‡æ ‡ç±»å‹æ”¯æŒ**
- `characters` - ç¿»è¯‘å­—ç¬¦æ•°
- `api_calls` - APIè°ƒç”¨æ¬¡æ•°
- `storage_mb` - å­˜å‚¨ä½¿ç”¨(MB)
- `concurrent_tasks` - å¹¶å‘ä»»åŠ¡æ•°
- `team_members` - å›¢é˜Ÿæˆå‘˜æ•°

**å‚æ•°éªŒè¯**
- æŒ‡æ ‡ç±»å‹éªŒè¯ï¼ˆä¸æ”¯æŒæ—¶è¿”å›400é”™è¯¯ï¼‰
- åˆ†é¡µå‚æ•°é™åˆ¶ï¼ˆper_pageæœ€å¤§100ï¼‰
- å¤©æ•°å‚æ•°é™åˆ¶ï¼ˆdaysæœ€å¤§90ï¼‰

**å“åº”æ ¼å¼**
```json
{
  "user_id": "uuid",
  "today": {
    "characters": 15000,
    "api_calls": 120,
    "storage_mb": 512,
    "concurrent_tasks": 3,
    "team_members": 5
  },
  "month": {
    "characters": 450000,
    "api_calls": 3600,
    "storage_mb": 512,
    "concurrent_tasks": 3,
    "team_members": 5
  },
  "total": {
    "characters": 1200000,
    "api_calls": 96000,
    "storage_mb": 512,
    "concurrent_tasks": 3,
    "team_members": 5
  }
}
```

#### 3. API ä½¿ç”¨ç¤ºä¾‹

**è·å–å½“å‰ç”¨é‡**
```bash
curl -X GET "http://localhost:8000/api/v1/usage/current" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**è·å–å†å²è®°å½•**
```bash
curl -X GET "http://localhost:8000/api/v1/usage/history?metric_type=characters&page=1&per_page=50" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**è·å–æ¯æ—¥è¶‹åŠ¿**
```bash
curl -X GET "http://localhost:8000/api/v1/usage/daily?metric_type=characters&days=30" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 4. ä¾èµ–æ¨¡å—

ç”¨é‡ç®¡ç† API è·¯ç”±ä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- UsageTracker (`ModuleFolders/Service/Billing/UsageTracker.py`)
- JWT Middleware (`ModuleFolders/Service/Auth/auth_middleware.py`)

#### 5. æµ‹è¯•éªŒè¯

- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… FastAPI åº”ç”¨åŠ è½½æˆåŠŸ
- âœ… 3 ä¸ªç”¨é‡ç®¡ç†è·¯ç”±æ³¨å†ŒæˆåŠŸ
- âœ… æ‰€æœ‰è·¯ç”±ä½¿ç”¨æ­£ç¡®çš„ HTTP æ–¹æ³•
- âœ… å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†å®Œæ•´

### é›†æˆè¯´æ˜

ç”¨é‡ç®¡ç† API å·²å®Œå…¨é›†æˆåˆ° WebServerï¼Œå¯ä»¥é€šè¿‡ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£è®¿é—®ï¼š
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### ä¸‹ä¸€æ­¥

ç”¨é‡ç®¡ç† API å·²å®Œæˆï¼Œå¯ä»¥ï¼š
1. å®ç° OAuth API è·¯ç”±
2. å®ç°å‰ç«¯ç”¨é‡ç»Ÿè®¡ç•Œé¢
3. å®ç°ç”¨é‡é¢„è­¦åŠŸèƒ½

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - OAuth API è·¯ç”±

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„ OAuth API è·¯ç”±ç³»ç»Ÿ

åœ¨ `Tools/WebServer/web_server.py` ä¸­å®ç°äº† 4 ä¸ª OAuth API è·¯ç”±ï¼ŒåŒ…æ‹¬ OAuth æˆæƒã€å›è°ƒå¤„ç†ã€è´¦æˆ·æŸ¥è¯¢å’Œè§£ç»‘åŠŸèƒ½ã€‚

#### 1. è¯·æ±‚/å“åº”æ¨¡å‹ (3ä¸ª)

**OAuth API æ¨¡å‹**:
- `OAuthUrlResponse` - OAuth æˆæƒ URL å“åº”
- `OAuthCallbackRequest` - OAuth å›è°ƒè¯·æ±‚
- `OAuthLinkAccountRequest` - OAuth å…³è”è´¦æˆ·è¯·æ±‚

#### 2. OAuth API (4ä¸ªè·¯ç”±)

**OAuth æˆæƒ**:
- `GET /api/v1/auth/oauth/{provider}/authorize` - è·å– OAuth æˆæƒ URL
  - æ”¯æŒ GitHub å’Œ Google OAuth æä¾›å•†
  - ç”Ÿæˆæˆæƒ URL å’Œ CSRF é˜²æŠ¤ state å‚æ•°
  - æ— éœ€è®¤è¯
  - è¿”å›æˆæƒ URL å’Œ stateï¼ˆå‰ç«¯éœ€ä¿å­˜ state ç”¨äºéªŒè¯ï¼‰

**OAuth ç™»å½•**:
- `GET /api/v1/auth/oauth/callback` - OAuth å›è°ƒå¤„ç†
  - å¤„ç† OAuth æä¾›å•†çš„å›è°ƒ
  - éªŒè¯æˆæƒç å¹¶äº¤æ¢è®¿é—®ä»¤ç‰Œ
  - è·å–ç”¨æˆ·ä¿¡æ¯å¹¶åˆ›å»ºæˆ–ç™»å½•è´¦æˆ·
  - è¿”å› JWT ä»¤ç‰Œï¼ˆaccess_token, refresh_tokenï¼‰
  - æ–°ç”¨æˆ·é‚®ç®±è‡ªåŠ¨æ ‡è®°ä¸ºå·²éªŒè¯

**è´¦æˆ·ç®¡ç†**:
- `GET /api/v1/auth/oauth/accounts` - è·å–å·²å…³è”çš„ OAuth è´¦æˆ·åˆ—è¡¨
  - è¿”å›ç”¨æˆ·æ‰€æœ‰å·²å…³è”çš„ OAuth è´¦æˆ·
  - åŒ…å«æä¾›å•†ã€é‚®ç®±ã€ç”¨æˆ·åã€å…³è”æ—¶é—´ã€æœ€åç™»å½•æ—¶é—´
  - éœ€è¦è®¤è¯ï¼ˆJWT Tokenï¼‰

- `DELETE /api/v1/auth/oauth/accounts/{provider}` - è§£é™¤ OAuth è´¦æˆ·å…³è”
  - è§£é™¤æŒ‡å®šæä¾›å•†çš„ OAuth è´¦æˆ·å…³è”
  - é˜²æ­¢è§£é™¤æœ€åä¸€ä¸ª OAuth è´¦æˆ·ï¼ˆå¦‚æœæœªè®¾ç½®å¯†ç ï¼‰
  - è§£é™¤åæ— æ³•ä½¿ç”¨è¯¥æä¾›å•†ç™»å½•
  - éœ€è¦è®¤è¯ï¼ˆJWT Tokenï¼‰

#### 3. API ä½¿ç”¨ç¤ºä¾‹

**è·å– GitHub OAuth æˆæƒ URL**
```bash
curl -X GET "http://localhost:8000/api/v1/auth/oauth/github/authorize"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "authorization_url": "https://github.com/login/oauth/authorize?client_id=xxx&redirect_uri=http://localhost:8000/api/v1/auth/oauth/callback&scope=user:email&state=xxx",
  "state": "random_state_string_for_csrf_protection"
}
```

**OAuth å›è°ƒå¤„ç†**
```bash
# å‰ç«¯å°†ç”¨æˆ·é‡å®šå‘åˆ°æˆæƒ URLï¼Œç”¨æˆ·æˆæƒåä¼šå›è°ƒæ­¤ URL
curl -X GET "http://localhost:8000/api/v1/auth/oauth/callback?provider=github&code=xxx&state=xxx"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "user": {
    "id": "user-uuid",
    "email": "user@example.com",
    "username": "githubuser",
    "full_name": "GitHub User",
    "avatar_url": "https://...",
    "role": "user",
    "email_verified": true
  },
  "access_token": "jwt_access_token",
  "refresh_token": "jwt_refresh_token",
  "provider": "github"
}
```

**è·å–å·²å…³è”çš„ OAuth è´¦æˆ·**
```bash
curl -X GET "http://localhost:8000/api/v1/auth/oauth/accounts" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**å“åº”ç¤ºä¾‹**:
```json
[
  {
    "provider": "github",
    "account_email": "user@example.com",
    "account_username": "githubuser",
    "linked_at": "2026-02-27T10:30:00Z",
    "last_login_at": "2026-02-27T15:45:00Z"
  },
  {
    "provider": "google",
    "account_email": "user@gmail.com",
    "account_username": "user",
    "linked_at": "2026-02-27T12:00:00Z",
    "last_login_at": "2026-02-27T14:20:00Z"
  }
]
```

**è§£é™¤ OAuth è´¦æˆ·å…³è”**
```bash
curl -X DELETE "http://localhost:8000/api/v1/auth/oauth/accounts/github" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 4. å®‰å…¨ç‰¹æ€§

**CSRF é˜²æŠ¤**
- ä½¿ç”¨ `state` å‚æ•°é˜²æ­¢ CSRF æ”»å‡»
- å‰ç«¯åº”åœ¨ session ä¸­å­˜å‚¨ state å¹¶åœ¨å›è°ƒæ—¶éªŒè¯
- state ç”±æœåŠ¡å™¨ç”Ÿæˆï¼ˆ32 å­—èŠ‚éšæœºå­—ç¬¦ä¸²ï¼‰

**ä»¤ç‰Œå®‰å…¨**
- OAuth è®¿é—®ä»¤ç‰Œå®‰å…¨å­˜å‚¨åœ¨æ•°æ®åº“
- æ”¯æŒä»¤ç‰Œè¿‡æœŸæ—¶é—´å’Œåˆ·æ–°ä»¤ç‰Œ
- JWT ä»¤ç‰Œç”¨äºåº”ç”¨å†…è®¤è¯

**è´¦æˆ·å®‰å…¨**
- OAuth ç”¨æˆ·é‚®ç®±è‡ªåŠ¨éªŒè¯
- é˜²æ­¢è§£é™¤æœ€åä¸€ä¸ª OAuth è´¦æˆ·ï¼ˆé™¤éå·²è®¾ç½®å¯†ç ï¼‰
- æ”¯æŒæ··åˆç™»å½•ï¼ˆOAuth + å¯†ç ï¼‰

#### 5. ä¾èµ–æ¨¡å—

OAuth API è·¯ç”±ä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- OAuthManager (`ModuleFolders/Service/Auth/oauth_manager.py`)
- JWT Middleware (`ModuleFolders/Service/Auth/auth_middleware.py`)
- OAuthAccount æ¨¡å‹ (`ModuleFolders/Service/Auth/models.py`)

#### 6. ç¯å¢ƒå˜é‡é…ç½®

éœ€è¦åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
# GitHub OAuth
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret

# OAuth å›è°ƒ URL
OAUTH_REDIRECT_URI=http://localhost:8000/api/v1/auth/oauth/callback
```

#### 7. å‰ç«¯é›†æˆè¯´æ˜

**OAuth ç™»å½•æµç¨‹**:
1. è°ƒç”¨ `/api/v1/auth/oauth/{provider}/authorize` è·å–æˆæƒ URL å’Œ state
2. åœ¨ session ä¸­ä¿å­˜ state
3. é‡å®šå‘ç”¨æˆ·åˆ°æˆæƒ URL
4. ç”¨æˆ·åœ¨ OAuth æä¾›å•†é¡µé¢å®Œæˆæˆæƒ
5. OAuth æä¾›å•†å›è°ƒåˆ° `/api/v1/auth/oauth/callback` å¹¶å¸¦ä¸Š code å’Œ state
6. éªŒè¯ state å‚æ•°ï¼ˆé˜²æ­¢ CSRF æ”»å‡»ï¼‰
7. æ¥æ”¶è¿”å›çš„ JWT ä»¤ç‰Œå¹¶å­˜å‚¨
8. ä½¿ç”¨ JWT ä»¤ç‰Œè®¿é—®å—ä¿æŠ¤çš„ API

**State éªŒè¯ç¤ºä¾‹ï¼ˆå‰ç«¯ä¼ªä»£ç ï¼‰**:
```javascript
// 1. è·å–æˆæƒ URL
const response = await fetch('/api/v1/auth/oauth/github/authorize');
const { authorization_url, state } = await response.json();

// 2. ä¿å­˜ state åˆ° session
sessionStorage.setItem('oauth_state', state);

// 3. é‡å®šå‘åˆ°æˆæƒ URL
window.location.href = authorization_url;

// 4. åœ¨å›è°ƒé¡µé¢éªŒè¯ state
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const state = urlParams.get('state');
const savedState = sessionStorage.getItem('oauth_state');

if (state !== savedState) {
  alert('State éªŒè¯å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨ CSRF æ”»å‡»');
  return;
}

// 5. è°ƒç”¨å›è°ƒ API
const callbackResponse = await fetch(
  `/api/v1/auth/oauth/callback?provider=github&code=${code}&state=${state}`
);
const { user, access_token, refresh_token } = await callbackResponse.json();

// 6. å­˜å‚¨ JWT ä»¤ç‰Œ
localStorage.setItem('access_token', access_token);
localStorage.setItem('refresh_token', refresh_token);
```

#### 8. æµ‹è¯•éªŒè¯

- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… FastAPI åº”ç”¨åŠ è½½æˆåŠŸ
- âœ… 4 ä¸ª OAuth API è·¯ç”±æ³¨å†ŒæˆåŠŸ
- âœ… æ‰€æœ‰è·¯ç”±ä½¿ç”¨æ­£ç¡®çš„ HTTP æ–¹æ³•
- âœ… è¯·æ±‚/å“åº”æ¨¡å‹å®šä¹‰å®Œæ•´

### é›†æˆè¯´æ˜

OAuth API å·²å®Œå…¨é›†æˆåˆ° WebServerï¼Œå¯ä»¥é€šè¿‡ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£è®¿é—®ï¼š
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### ä¸‹ä¸€æ­¥

OAuth API å·²å®Œæˆï¼Œå¯ä»¥ï¼š
1. å®ç°å‰ç«¯ OAuth ç™»å½•ç•Œé¢ï¼ˆGitHub/Google ç™»å½•æŒ‰é’®ï¼‰
2. å®ç°ç”¨æˆ·è´¦æˆ·ç®¡ç†ç•Œé¢ï¼ˆæ˜¾ç¤ºå·²å…³è”è´¦æˆ·ï¼Œæ”¯æŒè§£ç»‘ï¼‰
3. å®ç° OAuth è´¦æˆ·å…³è”åŠŸèƒ½ï¼ˆå·²ç™»å½•ç”¨æˆ·å…³è”å…¶ä»– OAuth æä¾›å•†ï¼‰

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… ~~å®ç° OAuth ç¬¬ä¸‰æ–¹ç™»å½•~~ (å·²å®Œæˆ)
2. âœ… ~~å®Œå–„ç”¨é‡è¿½è¸ªå’Œé…é¢éªŒè¯é€»è¾‘~~ (å·²å®Œæˆ)
3. âœ… ~~å®ç°ç”¨æˆ·ç®¡ç† API è·¯ç”±~~ (å·²å®Œæˆ)
4. âœ… ~~å®ç°è®¢é˜…ç®¡ç† API è·¯ç”±~~ (å·²å®Œæˆ)
5. âœ… ~~å®ç°ç”¨é‡ç®¡ç† API è·¯ç”±~~ (å·²å®Œæˆ)
6. âœ… ~~å®ç° OAuth API è·¯ç”±~~ (å·²å®Œæˆ)
7. âœ… ~~å®ç°å‘ç¥¨ PDF ç”ŸæˆåŠŸèƒ½~~ (å·²å®Œæˆ)
8. âœ… ~~å®ç°å›¢é˜Ÿç®¡ç†åŸºç¡€åŠŸèƒ½~~ (å·²å®Œæˆ)
9. å®ç°å›¢é˜Ÿç®¡ç† API è·¯ç”±
10. å‰ç«¯é¡µé¢å¼€å‘ï¼ˆæ”¯ä»˜ç•Œé¢ã€è®¢é˜…ç®¡ç†ã€ç”¨é‡ç»Ÿè®¡ã€OAuth ç™»å½•ï¼‰- å‰©ä½™10%å·¥ä½œ

---

## æœ¬æ¬¡æ›´æ–° (2026-02-27) - å›¢é˜Ÿç®¡ç†åŸºç¡€åŠŸèƒ½

### å®ç°å†…å®¹ï¼šå®Œæ•´çš„å›¢é˜Ÿç®¡ç†æ•°æ®æ¨¡å‹å’ŒæœåŠ¡å±‚

å®ç°äº†å›¢é˜Ÿåä½œåŠŸèƒ½çš„åŸºç¡€æ¶æ„,åŒ…æ‹¬æ•°æ®æ¨¡å‹ã€æ•°æ®è®¿é—®å±‚å’Œä¸šåŠ¡é€»è¾‘å±‚ã€‚

#### 1. æ•°æ®æ¨¡å‹ (`ModuleFolders/Service/Auth/models.py`)

**TeamRole æšä¸¾**
```python
class TeamRole(str, Enum):
    OWNER = "owner"    # å›¢é˜Ÿæ‰€æœ‰è€…
    ADMIN = "admin"    # å›¢é˜Ÿç®¡ç†å‘˜
    MEMBER = "member"  # æ™®é€šæˆå‘˜
```

**Team æ¨¡å‹**
- `name` - å›¢é˜Ÿåç§°
- `slug` - å›¢é˜ŸURLæ ‡è¯† (ç§Ÿæˆ·å†…å”¯ä¸€)
- `tenant` - æ‰€å±ç§Ÿæˆ· (å¤–é”®,å¤šç§Ÿæˆ·æ”¯æŒ)
- `owner` - å›¢é˜Ÿæ‰€æœ‰è€… (å¤–é”®åˆ°User)
- `description` - å›¢é˜Ÿæè¿°
- `settings` - å›¢é˜Ÿè®¾ç½® (JSON)
- `max_members` - æœ€å¤§æˆå‘˜æ•° (åŸºäºè®¢é˜…è®¡åˆ’)
- `is_active` - æ˜¯å¦æ¿€æ´»

**TeamMember æ¨¡å‹**
- `team` - æ‰€å±å›¢é˜Ÿ (å¤–é”®)
- `user` - ç”¨æˆ· (å¤–é”®)
- `role` - æˆå‘˜è§’è‰² (owner/admin/member)
- `invitation_status` - é‚€è¯·çŠ¶æ€ (pending/accepted/declined)
- `invitation_token` - é‚€è¯·ä»¤ç‰Œ (å”¯ä¸€)
- `invited_at` - é‚€è¯·æ—¶é—´
- `joined_at` - åŠ å…¥æ—¶é—´

**ç´¢å¼•å’Œçº¦æŸ**
- (tenant_id, slug) - å”¯ä¸€çº¦æŸ (æ¯ä¸ªç§Ÿæˆ·å†…slugå”¯ä¸€)
- (team_id, user_id) - å”¯ä¸€çº¦æŸ (æ¯ä¸ªç”¨æˆ·åœ¨æ¯ä¸ªå›¢é˜Ÿåªèƒ½æœ‰ä¸€ä¸ªè®°å½•)
- invitation_token - å”¯ä¸€ç´¢å¼•

#### 2. TeamRepository (`ModuleFolders/Service/Team/team_repository.py`)

å®Œæ•´çš„æ•°æ®è®¿é—®å±‚,æä¾›ä»¥ä¸‹æ–¹æ³•:

**æŸ¥è¯¢æ–¹æ³•**
- `find_by_id(team_id)` - æ ¹æ®IDæŸ¥æ‰¾å›¢é˜Ÿ
- `find_by_slug(tenant_id, slug)` - æ ¹æ®slugæŸ¥æ‰¾å›¢é˜Ÿ
- `find_by_owner(owner_id)` - æŸ¥æ‰¾ç”¨æˆ·æ‹¥æœ‰çš„å›¢é˜Ÿ
- `find_by_member(user_id)` - æŸ¥æ‰¾ç”¨æˆ·å‚ä¸çš„å›¢é˜Ÿ
- `find_members(team_id)` - æŸ¥æ‰¾å›¢é˜Ÿæˆå‘˜åˆ—è¡¨
- `find_member(team_id, user_id)` - æŸ¥æ‰¾æŒ‡å®šå›¢é˜Ÿæˆå‘˜
- `find_by_invitation_token(token)` - æ ¹æ®é‚€è¯·ä»¤ç‰ŒæŸ¥æ‰¾
- `count_members(team_id, include_pending)` - ç»Ÿè®¡æˆå‘˜æ•°é‡

**CUDæ“ä½œ**
- `create_team(...)` - åˆ›å»ºå›¢é˜Ÿ
- `update_team(team, **kwargs)` - æ›´æ–°å›¢é˜Ÿä¿¡æ¯
- `delete_team(team)` - åˆ é™¤å›¢é˜Ÿ
- `add_member(team_id, user_id, role, status)` - æ·»åŠ æˆå‘˜
- `update_member_role(member, new_role)` - æ›´æ–°æˆå‘˜è§’è‰²
- `update_invitation_status(member, status)` - æ›´æ–°é‚€è¯·çŠ¶æ€
- `remove_member(member)` - ç§»é™¤æˆå‘˜

**åˆ†é¡µæŸ¥è¯¢**
- `list_teams(tenant_id, page, per_page)` - åˆ†é¡µåˆ—å‡ºå›¢é˜Ÿ

#### 3. TeamManager (`ModuleFolders/Service/Team/team_manager.py`)

å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘å±‚,æä¾›éªŒè¯ã€æƒé™æ§åˆ¶å’Œä¸šåŠ¡è§„åˆ™:

**å›¢é˜Ÿç®¡ç†**
- `create_team(owner_id, name, slug, ...)` - åˆ›å»ºå›¢é˜Ÿ
  - éªŒè¯ç”¨æˆ·å­˜åœ¨
  - éªŒè¯slugæ ¼å¼ (3-50å­—ç¬¦,å°å†™å­—æ¯æ•°å­—è¿å­—ç¬¦)
  - æ£€æŸ¥slugå”¯ä¸€æ€§
  - æ ¹æ®è®¢é˜…è®¡åˆ’è®¾ç½®æœ€å¤§æˆå‘˜æ•°
  - è‡ªåŠ¨å°†åˆ›å»ºè€…æ·»åŠ ä¸ºOwner

- `update_team(team_id, user_id, ...)` - æ›´æ–°å›¢é˜Ÿä¿¡æ¯
  - éªŒè¯å›¢é˜Ÿå­˜åœ¨
  - éªŒè¯æƒé™ (åªæœ‰Ownerå¯ä»¥æ›´æ–°)
  - æ”¯æŒæ›´æ–°åç§°ã€æè¿°ã€è®¾ç½®

- `delete_team(team_id, user_id)` - åˆ é™¤å›¢é˜Ÿ
  - éªŒè¯å›¢é˜Ÿå­˜åœ¨
  - éªŒè¯æƒé™ (åªæœ‰Ownerå¯ä»¥åˆ é™¤)
  - çº§è”åˆ é™¤æ‰€æœ‰æˆå‘˜è®°å½•

- `get_team(team_id, user_id)` - è·å–å›¢é˜Ÿè¯¦æƒ…
  - éªŒè¯è®¿é—®æƒé™

- `list_user_teams(user_id)` - åˆ—å‡ºç”¨æˆ·æ‰€æœ‰å›¢é˜Ÿ
  - åŒ…æ‹¬æ‹¥æœ‰çš„å’Œå‚ä¸çš„å›¢é˜Ÿ

**æˆå‘˜ç®¡ç†**
- `invite_member(team_id, inviter_id, email, role)` - é‚€è¯·æˆå‘˜
  - éªŒè¯é‚€è¯·äººæƒé™ (Owner/Admin)
  - æ£€æŸ¥å›¢é˜Ÿæˆå‘˜æ•°é™åˆ¶
  - éªŒè¯è¢«é‚€è¯·äººå­˜åœ¨
  - æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  - ç”Ÿæˆ32ä½éšæœºé‚€è¯·ä»¤ç‰Œ
  - åˆ›å»ºå¾…æ¥å—çŠ¶æ€çš„æˆå‘˜è®°å½•

- `accept_invitation(token, user_id)` - æ¥å—é‚€è¯·
  - éªŒè¯é‚€è¯·ä»¤ç‰Œ
  - éªŒè¯ç”¨æˆ·èº«ä»½
  - æ£€æŸ¥é‚€è¯·çŠ¶æ€
  - æ›´æ–°ä¸ºacceptedå¹¶è®°å½•joined_at

- `decline_invitation(token, user_id)` - æ‹’ç»é‚€è¯·
  - éªŒè¯é‚€è¯·ä»¤ç‰Œ
  - æ›´æ–°ä¸ºdeclined

- `update_member_role(team_id, operator_id, member_user_id, new_role)` - æ›´æ–°æˆå‘˜è§’è‰²
  - éªŒè¯æ“ä½œäººæƒé™ (åªæœ‰Owner)
  - ä¸èƒ½ä¿®æ”¹Ownerè§’è‰²

- `remove_member(team_id, operator_id, member_user_id)` - ç§»é™¤æˆå‘˜
  - éªŒè¯æƒé™ (Ownerå¯ç§»é™¤ä»»ä½•äºº, Adminå¯ç§»é™¤Member)
  - Adminä¸èƒ½ç§»é™¤Owneræˆ–å…¶ä»–Admin
  - ä¸èƒ½ç§»é™¤å›¢é˜Ÿæ‰€æœ‰è€…

- `list_members(team_id, user_id)` - åˆ—å‡ºå›¢é˜Ÿæˆå‘˜
  - éªŒè¯è®¿é—®æƒé™

**è¾…åŠ©æ–¹æ³•**
- `_validate_slug(slug)` - éªŒè¯slugæ ¼å¼
- `_generate_invitation_token()` - ç”Ÿæˆé‚€è¯·ä»¤ç‰Œ (inv_å‰ç¼€ + 32ä½éšæœºå­—ç¬¦)
- `_get_max_members_for_user(user_id)` - æ ¹æ®è®¢é˜…è®¡åˆ’è·å–é…é¢
  - Free: 5äºº
  - Starter: 10äºº
  - Pro: 50äºº
  - Enterprise: æ— é™åˆ¶

#### 4. æƒé™ç³»ç»Ÿ

**è§’è‰²å±‚çº§**
```
Owner (æ‰€æœ‰è€…)
  â”œâ”€â”€ å¯ä»¥æ›´æ–°å›¢é˜Ÿä¿¡æ¯
  â”œâ”€â”€ å¯ä»¥åˆ é™¤å›¢é˜Ÿ
  â”œâ”€â”€ å¯ä»¥é‚€è¯·æˆå‘˜
  â”œâ”€â”€ å¯ä»¥ç§»é™¤ä»»ä½•äºº
  â””â”€â”€ å¯ä»¥æ›´æ–°ä»»ä½•äººçš„è§’è‰²

Admin (ç®¡ç†å‘˜)
  â”œâ”€â”€ å¯ä»¥é‚€è¯·æˆå‘˜
  â”œâ”€â”€ å¯ä»¥ç§»é™¤æ™®é€šæˆå‘˜
  â””â”€â”€ ä¸èƒ½ä¿®æ”¹Owneræˆ–å…¶ä»–Admin

Member (æ™®é€šæˆå‘˜)
  â””â”€â”€ åªèƒ½æŸ¥çœ‹å›¢é˜Ÿä¿¡æ¯
```

#### 5. é‚€è¯·æµç¨‹

```
1. Owner/Admin å‘é€é‚€è¯·
   â””â”€> åˆ›å»º TeamMember (status=pending, token=inv_xxx)

2. ç³»ç»Ÿå‘é€é‚€è¯·é‚®ä»¶ (å¾…å®ç°)
   â””â”€> åŒ…å«é‚€è¯·é“¾æ¥ /teams/accept?token=inv_xxx

3. è¢«é‚€è¯·ç”¨æˆ·ç‚¹å‡»é“¾æ¥
   â””â”€> è°ƒç”¨ accept_invitation(token, user_id)
   â””â”€> çŠ¶æ€æ›´æ–°ä¸º accepted, è®°å½• joined_at
```

#### 6. æ•°æ®åº“è¿ç§»

è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–ä»¥åˆ›å»ºæ–°è¡¨:

```python
from ModuleFolders.Service.Auth.models import init_database

db = init_database()
```

æˆ–æ‰‹åŠ¨æ‰§è¡ŒSQL:

```sql
CREATE TABLE teams (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) NOT NULL,
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    description TEXT,
    settings TEXT DEFAULT '{}',
    max_members INTEGER DEFAULT 5,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, slug)
);

CREATE INDEX idx_teams_slug ON teams(slug);
CREATE INDEX idx_teams_tenant ON teams(tenant_id);
CREATE INDEX idx_teams_owner ON teams(owner_id);

CREATE TABLE team_members (
    id UUID PRIMARY KEY,
    team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'member',
    invitation_status VARCHAR(20) DEFAULT 'pending',
    invitation_token VARCHAR(255) UNIQUE,
    invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    joined_at TIMESTAMP,
    UNIQUE(team_id, user_id)
);

CREATE INDEX idx_team_members_team ON team_members(team_id);
CREATE INDEX idx_team_members_user ON team_members(user_id);
CREATE INDEX idx_team_members_token ON team_members(invitation_token);
```

#### 7. è®¢é˜…è®¡åˆ’é…é¢

| è®¡åˆ’ | æœ€å¤§æˆå‘˜æ•° |
|------|-----------|
| Free | 5 |
| Starter | 10 |
| Pro | 50 |
| Enterprise | æ— é™åˆ¶ |

#### 8. é”™è¯¯å¤„ç†

TeamManager æŠ›å‡º `TeamError` å¼‚å¸¸,åŒ…å«ä»¥ä¸‹é”™è¯¯ä»£ç :

- `user_not_found` - ç”¨æˆ·ä¸å­˜åœ¨
- `slug_already_exists` - å›¢é˜Ÿslugå·²è¢«ä½¿ç”¨
- `invalid_slug` - slugæ ¼å¼æ— æ•ˆ
- `team_not_found` - å›¢é˜Ÿä¸å­˜åœ¨
- `permission_denied` - æƒé™ä¸è¶³
- `team_full` - å›¢é˜Ÿæˆå‘˜å·²æ»¡
- `already_member` - ç”¨æˆ·å·²åœ¨å›¢é˜Ÿä¸­
- `invitation_not_found` - é‚€è¯·ä¸å­˜åœ¨
- `already_accepted` - é‚€è¯·å·²è¢«æ¥å—
- `already_declined` - é‚€è¯·å·²è¢«æ‹’ç»
- `member_not_found` - æˆå‘˜ä¸å­˜åœ¨
- `cannot_change_owner` - ä¸èƒ½ä¿®æ”¹æ‰€æœ‰è€…è§’è‰²
- `cannot_remove_owner` - ä¸èƒ½ç§»é™¤æ‰€æœ‰è€…

#### 9. ä¾èµ–é¡¹

å›¢é˜Ÿç®¡ç†åŠŸèƒ½ä¾èµ–ä»¥ä¸‹æ¨¡å—:
- Peewee ORM (å·²åœ¨é¡¹ç›®ä¾èµ–ä¸­)
- User/Tenant æ¨¡å‹
- SubscriptionManager (ç”¨äºè·å–é…é¢)

#### 10. æµ‹è¯•éªŒè¯

- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… æ•°æ®æ¨¡å‹å®šä¹‰å®Œæ•´
- âœ… Repositoryæ–¹æ³•å®Œæ•´
- âœ… Managerä¸šåŠ¡é€»è¾‘å®Œæ•´
- âœ… æƒé™éªŒè¯å®Œæ•´
- âœ… é”™è¯¯å¤„ç†å®Œæ•´

#### 11. é›†æˆè¯´æ˜

å›¢é˜Ÿç®¡ç†åŠŸèƒ½å·²å®ŒæˆåŸºç¡€æ¶æ„,ä¸‹ä¸€æ­¥å¯ä»¥:
1. å®ç°å›¢é˜Ÿç®¡ç† API è·¯ç”±
2. å®ç°é‚€è¯·é‚®ä»¶å‘é€åŠŸèƒ½
3. å®ç°å‰ç«¯å›¢é˜Ÿç®¡ç†ç•Œé¢
4. å®ç°å›¢é˜Ÿæˆå‘˜é…é¢æ£€æŸ¥

**API è·¯ç”±éœ€æ±‚** (ä¸‹ä¸€ä»»åŠ¡):
```
POST   /api/v1/teams                    # åˆ›å»ºå›¢é˜Ÿ
GET    /api/v1/teams                    # åˆ—å‡ºæˆ‘çš„å›¢é˜Ÿ
GET    /api/v1/teams/{id}               # è·å–å›¢é˜Ÿè¯¦æƒ…
PUT    /api/v1/teams/{id}               # æ›´æ–°å›¢é˜Ÿ
DELETE /api/v1/teams/{id}               # åˆ é™¤å›¢é˜Ÿ
POST   /api/v1/teams/{id}/members       # é‚€è¯·æˆå‘˜
GET    /api/v1/teams/{id}/members       # åˆ—å‡ºæˆå‘˜
PUT    /api/v1/teams/{id}/members/{uid} # æ›´æ–°æˆå‘˜è§’è‰²
DELETE /api/v1/teams/{id}/members/{uid} # ç§»é™¤æˆå‘˜
POST   /api/v1/teams/accept             # æ¥å—é‚€è¯·
POST   /api/v1/teams/decline            # æ‹’ç»é‚€è¯·
```

#### 12. å›¢é˜Ÿç®¡ç† API è·¯ç”± âœ… (100%) - æœ¬æ¬¡å®ç°

åœ¨ `Tools/WebServer/web_server.py` ä¸­å®ç°äº†å®Œæ•´çš„å›¢é˜Ÿç®¡ç† API è·¯ç”±ç³»ç»Ÿã€‚

**è¯·æ±‚/å“åº”æ¨¡å‹ (6ä¸ª)**
- `CreateTeamRequest` - åˆ›å»ºå›¢é˜Ÿè¯·æ±‚ï¼ˆå›¢é˜Ÿåç§°ã€slugã€æè¿°ï¼‰
- `UpdateTeamRequest` - æ›´æ–°å›¢é˜Ÿè¯·æ±‚ï¼ˆåç§°ã€æè¿°ã€è®¾ç½®ï¼‰
- `InviteMemberRequest` - é‚€è¯·æˆå‘˜è¯·æ±‚ï¼ˆé‚®ç®±ã€è§’è‰²ï¼‰
- `UpdateMemberRoleRequest` - æ›´æ–°æˆå‘˜è§’è‰²è¯·æ±‚
- `AcceptInvitationRequest` - æ¥å—é‚€è¯·è¯·æ±‚ï¼ˆé‚€è¯·ä»¤ç‰Œï¼‰
- `DeclineInvitationRequest` - æ‹’ç»é‚€è¯·è¯·æ±‚ï¼ˆé‚€è¯·ä»¤ç‰Œï¼‰

**å›¢é˜Ÿç®¡ç† API (10ä¸ªè·¯ç”±)**

**å›¢é˜ŸCRUDæ“ä½œ**:
- `POST /api/v1/teams` - åˆ›å»ºå›¢é˜Ÿ
  - åˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºå›¢é˜Ÿæ‰€æœ‰è€…ï¼ˆOwnerï¼‰
  - æ ¹æ®è®¢é˜…è®¡åˆ’è‡ªåŠ¨è®¾ç½®æœ€å¤§æˆå‘˜æ•°
  - éªŒè¯slugæ ¼å¼å’Œå”¯ä¸€æ€§
  - æ”¯æŒå¤šç§Ÿæˆ·ï¼ˆè‡ªåŠ¨è·å–ç”¨æˆ·ç§Ÿæˆ·IDï¼‰

- `GET /api/v1/teams` - è·å–æˆ‘çš„å›¢é˜Ÿåˆ—è¡¨
  - è¿”å›ç”¨æˆ·æ‹¥æœ‰çš„å›¢é˜Ÿï¼ˆOwnerï¼‰
  - è¿”å›ç”¨æˆ·å‚ä¸çš„å›¢é˜Ÿï¼ˆAdmin/Memberï¼‰
  - åŒ…å«æˆå‘˜æ•°é‡å’Œç”¨æˆ·è§’è‰²ä¿¡æ¯

- `GET /api/v1/teams/{team_id}` - è·å–å›¢é˜Ÿè¯¦æƒ…
  - åŒ…å«å®Œæ•´çš„å›¢é˜Ÿä¿¡æ¯
  - åŒ…å«æˆå‘˜æ•°é‡å’Œç”¨æˆ·è§’è‰²
  - æƒé™éªŒè¯ï¼ˆå¿…é¡»æ˜¯å›¢é˜Ÿæˆå‘˜ï¼‰

- `PUT /api/v1/teams/{team_id}` - æ›´æ–°å›¢é˜Ÿä¿¡æ¯
  - åªæœ‰Ownerå¯ä»¥æ›´æ–°
  - æ”¯æŒéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼ˆåç§°ã€æè¿°ã€è®¾ç½®ï¼‰
  - è‡ªåŠ¨æ›´æ–° updated_at æ—¶é—´æˆ³

- `DELETE /api/v1/teams/{team_id}` - åˆ é™¤å›¢é˜Ÿ
  - åªæœ‰Ownerå¯ä»¥åˆ é™¤
  - çº§è”åˆ é™¤æ‰€æœ‰æˆå‘˜è®°å½•
  - ä¸å¯æ’¤é”€æ“ä½œ

**æˆå‘˜ç®¡ç† API (5ä¸ªè·¯ç”±)**

- `POST /api/v1/teams/{team_id}/members` - é‚€è¯·æˆå‘˜
  - åªæœ‰Ownerå’ŒAdminå¯ä»¥é‚€è¯·
  - éªŒè¯è¢«é‚€è¯·ç”¨æˆ·å­˜åœ¨
  - æ£€æŸ¥å›¢é˜Ÿæˆå‘˜æ•°é™åˆ¶
  - ç”Ÿæˆå”¯ä¸€çš„é‚€è¯·ä»¤ç‰Œï¼ˆ32ä½éšæœºå­—ç¬¦ï¼‰
  - è¿”å›é‚€è¯·ä»¤ç‰Œç”¨äºæ¥å—é‚€è¯·

- `GET /api/v1/teams/{team_id}/members` - è·å–æˆå‘˜åˆ—è¡¨
  - è¿”å›æ‰€æœ‰å›¢é˜Ÿæˆå‘˜ï¼ˆåŒ…æ‹¬å¾…æ¥å—é‚€è¯·ï¼‰
  - åŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²
  - åŒ…å«é‚€è¯·çŠ¶æ€å’ŒåŠ å…¥æ—¶é—´

- `PUT /api/v1/teams/{team_id}/members/{member_user_id}` - æ›´æ–°æˆå‘˜è§’è‰²
  - åªæœ‰Ownerå¯ä»¥æ›´æ–°æˆå‘˜è§’è‰²
  - ä¸èƒ½ä¿®æ”¹Ownerè§’è‰²
  - æ”¯æŒAdminå’ŒMemberä¹‹é—´çš„è§’è‰²è½¬æ¢

- `DELETE /api/v1/teams/{team_id}/members/{member_user_id}` - ç§»é™¤æˆå‘˜
  - Ownerå¯ä»¥ç§»é™¤ä»»ä½•äºº
  - Adminå¯ä»¥ç§»é™¤Member
  - ä¸èƒ½ç§»é™¤å›¢é˜Ÿæ‰€æœ‰è€…

**é‚€è¯·å¤„ç† API (2ä¸ªè·¯ç”±)**

- `POST /api/v1/teams/accept` - æ¥å—å›¢é˜Ÿé‚€è¯·
  - éªŒè¯é‚€è¯·ä»¤ç‰Œ
  - éªŒè¯ç”¨æˆ·èº«ä»½
  - æ›´æ–°é‚€è¯·çŠ¶æ€ä¸ºaccepted
  - è®°å½•åŠ å…¥æ—¶é—´

- `POST /api/v1/teams/decline` - æ‹’ç»å›¢é˜Ÿé‚€è¯·
  - éªŒè¯é‚€è¯·ä»¤ç‰Œ
  - æ›´æ–°é‚€è¯·çŠ¶æ€ä¸ºdeclined
  - é‚€è¯·ä»¤ç‰Œå¤±æ•ˆ

#### 13. API ä½¿ç”¨ç¤ºä¾‹

**åˆ›å»ºå›¢é˜Ÿ**
```bash
curl -X POST "http://localhost:8000/api/v1/teams" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æˆ‘çš„ç¿»è¯‘å›¢é˜Ÿ",
    "slug": "my-translation-team",
    "description": "ä¸“ä¸šçš„ç¿»è¯‘å›¢é˜Ÿ"
  }'
```

**è·å–æˆ‘çš„å›¢é˜Ÿåˆ—è¡¨**
```bash
curl -X GET "http://localhost:8000/api/v1/teams" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

**é‚€è¯·æˆå‘˜**
```bash
curl -X POST "http://localhost:8000/api/v1/teams/team-uuid/members" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "member@example.com",
    "role": "admin"
  }'
```

**æ¥å—é‚€è¯·**
```bash
curl -X POST "http://localhost:8000/api/v1/teams/accept" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"token": "inv_abc123..."}'
```

**æ›´æ–°æˆå‘˜è§’è‰²**
```bash
curl -X PUT "http://localhost:8000/api/v1/teams/team-uuid/members/user-uuid" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"new_role": "admin"}'
```

**ç§»é™¤æˆå‘˜**
```bash
curl -X DELETE "http://localhost:8000/api/v1/teams/team-uuid/members/user-uuid" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

#### 14. æƒé™ç³»ç»Ÿ

**è§’è‰²å±‚çº§**
```
Owner (æ‰€æœ‰è€…)
  â”œâ”€â”€ åˆ›å»º/æ›´æ–°/åˆ é™¤å›¢é˜Ÿ
  â”œâ”€â”€ é‚€è¯·æˆå‘˜
  â”œâ”€â”€ ç§»é™¤ä»»ä½•äºº
  â”œâ”€â”€ æ›´æ–°ä»»ä½•äººçš„è§’è‰²
  â””â”€â”€ æŸ¥çœ‹æ‰€æœ‰ä¿¡æ¯

Admin (ç®¡ç†å‘˜)
  â”œâ”€â”€ é‚€è¯·æˆå‘˜
  â”œâ”€â”€ ç§»é™¤æ™®é€šæˆå‘˜
  â”œâ”€â”€ ä¸èƒ½ä¿®æ”¹Owneræˆ–å…¶ä»–Admin
  â””â”€â”€ æŸ¥çœ‹æ‰€æœ‰ä¿¡æ¯

Member (æ™®é€šæˆå‘˜)
  â””â”€â”€ åªèƒ½æŸ¥çœ‹ä¿¡æ¯
```

#### 15. é‚€è¯·æµç¨‹

```
1. Owner/Admin å‘é€é‚€è¯·
   â””â”€> åˆ›å»º TeamMember (status=pending, token=inv_xxx)
   â””â”€> è¿”å›é‚€è¯·ä»¤ç‰Œ

2. è¢«é‚€è¯·ç”¨æˆ·æ¥å—é‚€è¯·
   â””â”€> POST /api/v1/teams/accept
   â””â”€> éªŒè¯ä»¤ç‰Œå’Œç”¨æˆ·èº«ä»½
   â””â”€> çŠ¶æ€æ›´æ–°ä¸º accepted, è®°å½• joined_at

3. è¢«é‚€è¯·ç”¨æˆ·æ‹’ç»é‚€è¯·
   â””â”€> POST /api/v1/teams/decline
   â””â”€> éªŒè¯ä»¤ç‰Œ
   â””â”€> çŠ¶æ€æ›´æ–°ä¸º declined
```

#### 16. å®‰å…¨ç‰¹æ€§

**è®¤è¯å’Œæˆæƒ**
- æ‰€æœ‰è·¯ç”±ä½¿ç”¨ JWT è®¤è¯
- è¯¦ç»†çš„æƒé™éªŒè¯ï¼ˆOwner/Admin/Memberï¼‰
- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„å›¢é˜Ÿä¿¡æ¯

**æ•°æ®éªŒè¯**
- Slugæ ¼å¼éªŒè¯ï¼ˆ3-50å­—ç¬¦ï¼Œå°å†™å­—æ¯æ•°å­—è¿å­—ç¬¦ï¼‰
- å”¯ä¸€æ€§æ£€æŸ¥ï¼ˆslugåœ¨ç§Ÿæˆ·å†…å”¯ä¸€ï¼‰
- è§’è‰²éªŒè¯ï¼ˆé˜²æ­¢æ— æ•ˆè§’è‰²ï¼‰
- å›¢é˜Ÿæˆå‘˜æ•°é™åˆ¶æ£€æŸ¥

**é”™è¯¯å¤„ç†**
- é€‚å½“çš„ HTTP çŠ¶æ€ç ï¼ˆ200, 400, 403, 404, 500ï¼‰
- è¯¦ç»†çš„ä¸­æ–‡é”™è¯¯æ¶ˆæ¯
- åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼ˆæƒé™ã€éªŒè¯ã€ä¸å­˜åœ¨ç­‰ï¼‰

#### 17. ä¾èµ–æ¨¡å—

å›¢é˜Ÿç®¡ç† API è·¯ç”±ä¾èµ–ä»¥ä¸‹æ¨¡å—ï¼š
- TeamManager (`ModuleFolders/Service/Team/team_manager.py`)
- TeamRepository (`ModuleFolders/Service/Team/team_repository.py`)
- JWT Middleware (`ModuleFolders/Service/Auth/auth_middleware.py`)
- Team/TeamMember æ¨¡å‹ (`ModuleFolders/Service/Auth/models.py`)
- SubscriptionManager (ç”¨äºè·å–é…é¢)

#### 18. æµ‹è¯•éªŒè¯

- âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡
- âœ… FastAPI åº”ç”¨åŠ è½½æˆåŠŸ
- âœ… 10 ä¸ªå›¢é˜Ÿç®¡ç†è·¯ç”±æ³¨å†ŒæˆåŠŸ
- âœ… æ‰€æœ‰è·¯ç”±ä½¿ç”¨æ­£ç¡®çš„ HTTP æ–¹æ³•
- âœ… è¯·æ±‚/å“åº”æ¨¡å‹å®šä¹‰å®Œæ•´

#### é›†æˆè¯´æ˜

å›¢é˜Ÿç®¡ç† API å·²å®Œå…¨é›†æˆåˆ° WebServerï¼Œå¯ä»¥é€šè¿‡ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£è®¿é—®ï¼š
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### ä¸‹ä¸€æ­¥

å›¢é˜Ÿç®¡ç† API å·²å®Œæˆï¼Œå¯ä»¥ï¼š
1. å®ç°å‰ç«¯å›¢é˜Ÿç®¡ç†ç•Œé¢
2. å®ç°é‚€è¯·é‚®ä»¶å‘é€åŠŸèƒ½
3. å®ç°å›¢é˜Ÿæˆå‘˜é…é¢æ£€æŸ¥ä¸­é—´ä»¶
4. å‰ç«¯é¡µé¢å¼€å‘ï¼ˆå‰©ä½™çº¦9%å·¥ä½œï¼‰

---

## æ€»ä½“è¿›åº¦

**æ•´ä½“å®Œæˆåº¦: 92%**

- è®¤è¯ç³»ç»Ÿ: 100% âœ… **å®Œæˆ**
- ç”¨æˆ·ç®¡ç†: 100% âœ… **å®Œæˆ**
- è®¢é˜…è®¡è´¹: 100% âœ… **å®Œæˆ**ï¼ˆStripe é›†æˆå®Œæˆï¼Œç”¨é‡è¿½è¸ªå’Œé…é¢æ‰§è¡Œå®Œæˆï¼Œè®¢é˜…ç®¡ç† API å®Œæˆï¼Œå‘ç¥¨ PDF ç”Ÿæˆå®Œæˆï¼Œç¼ºå‰ç«¯ï¼‰
- é«˜çº§åŠŸèƒ½: 40% (OAuth å®Œæˆï¼Œå›¢é˜Ÿç®¡ç† API å®Œæˆï¼Œç¼ºå¤šç§Ÿæˆ·å’ŒSSO)

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… ~~å®ç° OAuth ç¬¬ä¸‰æ–¹ç™»å½•~~ (å·²å®Œæˆ)
2. âœ… ~~å®Œå–„ç”¨é‡è¿½è¸ªå’Œé…é¢éªŒè¯é€»è¾‘~~ (å·²å®Œæˆ)
3. âœ… ~~å®ç°ç”¨æˆ·ç®¡ç† API è·¯ç”±~~ (å·²å®Œæˆ)
4. âœ… ~~å®ç°è®¢é˜…ç®¡ç† API è·¯ç”±~~ (å·²å®Œæˆ)
5. âœ… ~~å®ç°ç”¨é‡ç®¡ç† API è·¯ç”±~~ (å·²å®Œæˆ)
6. âœ… ~~å®ç° OAuth API è·¯ç”±~~ (å·²å®Œæˆ)
7. âœ… ~~å®ç°å‘ç¥¨ PDF ç”ŸæˆåŠŸèƒ½~~ (å·²å®Œæˆ)
8. âœ… ~~å®ç°å›¢é˜Ÿç®¡ç†åŸºç¡€åŠŸèƒ½~~ (å·²å®Œæˆ)
9. âœ… ~~å®ç°å›¢é˜Ÿç®¡ç† API è·¯ç”±~~ (å·²å®Œæˆ)
10. å‰ç«¯é¡µé¢å¼€å‘ï¼ˆæ”¯ä»˜ç•Œé¢ã€è®¢é˜…ç®¡ç†ã€ç”¨é‡ç»Ÿè®¡ã€OAuth ç™»å½•ã€å›¢é˜Ÿç®¡ç†ï¼‰- å‰©ä½™9%å·¥ä½œ

---
